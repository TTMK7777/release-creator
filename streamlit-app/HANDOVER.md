# オリコン顧客満足度 TOPICSサポートシステム - 引継ぎ資料

## 概要

オリコン顧客満足度ランキングのプレスリリース作成を支援するStreamlitアプリケーション。
Webスクレイピングによる過去データ取得と、Excelファイルアップロードによる最新データ統合機能を持つ。

## バージョン履歴

| バージョン | 日付 | 主な変更点 |
|-----------|------|-----------|
| v4.6 | 2025-11-27 | 1位獲得回数表示拡充（評価項目別・部門別タブに1位獲得回数ランキングを追加、年度検出ロジック修正：更新日を年度基準として使用） |
| v4.5 | 2025-11-27 | Multi-AIレビュー対応（25件の漏れランキング追加、Critical/Highバグ修正、コードリファクタリング） |
| v4.4 | 2025-11-27 | 同率順位対応（同点の場合「同率1位」として分析、2社/3社以上にも対応） |
| v4.3 | 2025-11-27 | 動的年度検出（トップページから実際の発表年度を自動判定、未発表年度スキップ） |
| v4.2 | 2025-11-27 | コードレビュー対応（セキュリティ改善、リトライ処理追加、動的年度範囲） |
| v4.1 | 2025-11-27 | 過去年度URL修正（/subpath/year/形式優先）、Altair faceted chartでグラフ表示 |
| v4.0 | 2025-11-27 | グラフ表示修正（評価項目別/部門別グラフがtrendsの有無に関わらず表示） |
| v3.9 | 2025-11-27 | バグ修正（0値判定、連続年数計算、グラフスコア、URL表示改善） |
| v3.8 | 2025-11-27 | UI改善（URL全文表示、タブ統合、評価項目別/部門別グラフ追加） |
| v3.7 | 2025-11-26 | 順位抽出ロジック修正（icon-rank優先、評価項目別テーブル除外） |
| v3.6 | 2025-11-25 | Excel抽出改善、URLリンク化、グラフ軸変更 |
| v3.5 | 2025-11-25 | 年度列誤検出防止、年度妥当性チェック |
| v3.4 | 2025-11-25 | Webサイト最新年度制限、デバッグログ追加 |
| v3.2 | 2025-11-25 | ファイルアップロード機能強化 |

## ファイル構成

```
streamlit-app/
├── app.py              # メインアプリケーション
├── scraper.py          # Webスクレイピングロジック
├── analyzer.py         # TOPICS分析・歴代記録分析
├── requirements.txt    # 依存パッケージ
├── HANDOVER.md         # 本引継ぎ資料
└── test/               # テストデータ
```

## 主要機能

### 1. Webスクレイピング (scraper.py)
- オリコン顧客満足度ランキングサイトからデータを取得
- URL構造:
  - 最新年度: `https://life.oricon.co.jp/rank-{slug}/`
  - 過去年度: `https://life.oricon.co.jp/rank-{slug}/{year}/`
- 対応ランキング: FX、携帯キャリア、格安SIM、証券、保険など

### 2. Excelファイル解析 (app.py: parse_uploaded_excel)

#### 対応フォーマット
オリコン内部Excelファイルの構造に対応:

```
Row 0: FX
Row 1: シート名（業態別、評価項目など）
Row 2: カテゴリ名（FX専業、スキャルピングトレードなど）
Row 3: n＝ 100（サンプルサイズ）
Row 4: 順位, ID, ランキング対象企業名, 回答者数, ...（ヘッダー）
Row 5〜: データ行
```

#### シート種別と処理

| シート種別 | 判定条件 | 抽出先 |
|-----------|---------|--------|
| 総合対象企業 | '総合' or '対象企業' in シート名 | overall_data |
| 評価項目 | '評価項目' in シート名 + 1列目が項目名 | item_data |
| 部門別 | '別' で終わるシート名 | dept_data |

#### 重要な修正点 (v3.5-3.7)

**問題1: 年度列の誤検出 (v3.5)**
- 原因: `回答者数（最新年）`列が「年」を含むため年度列として誤検出
- 修正: 除外パターンを追加 (`回答者数`, `最新年`, `前年` 等)
- 対策: 年度値が2000-2030の範囲外なら指定年度を使用

**問題2: 部門名の誤検出 (v3.6)**
- 原因: カテゴリ名検出が「n＝ 100」を拾っていた
- 修正: Row2を優先的に確認、`n＝`を含む行を除外

**問題3: 順位の誤取得 (v3.7)**
- 原因: 評価項目別テーブル内の `<img alt="2位">` を総合順位として誤取得
- 症状: Netflix(77点)が本来1位なのにDMM TV(75.3点)が1位と判定される
- 修正箇所: `scraper.py` の `_extract_ranking_data` メソッド
- 修正内容:
  1. `icon-rank` クラスを最優先で探索（総合順位の正しい表示場所）
  2. `td.rank` 内（評価項目別テーブル）の img を除外
  3. `ranking-score` セクション内の順位を除外
  4. 順位の範囲検証（1-100）を追加

**問題4: v3.8 UI改善 (2025-11-27)**
- 変更内容:
  1. URL表示を「リンクを開く」ボタンから全文URL表示に変更
  2. 見出し案タブを推奨TOPICSタブに統合（タブ数削減）
  3. 歴代記録タブに評価項目別/部門別の平均得点推移グラフを追加
  4. インパクト/最重要ラベルを推奨TOPICSから削除
  5. DataFrameから空白列や数字のみの列名を除外

**問題5: v3.9 バグ修正 (2025-11-27 - Codexレビュー指摘)**
- 修正箇所と内容:

  **app.py:**
  1. **0点/0位が空文字になるバグ** (77-78行目)
     - 原因: `score if score else ""` が0をfalsyとして扱う
     - 修正: `score if score is not None else ""`

  2. **ヘッダー検出条件の緩和** (235-241行目)
     - 原因: ID列必須条件が厳しすぎてシートをスキップ
     - 修正: 「順位」+「企業/ランキング/会社」で検出

  3. **セッション状態リセット** (902-903行目)
     - 原因: エラー後も前回結果が表示される
     - 修正: 実行開始時に `st.session_state.results_data = None`

  4. **グラフスコアフィルタリング** (1321, 1354行目)
     - 原因: `d.get("score")` が0を除外
     - 修正: `d.get("score") is not None`

  5. **評価項目別/部門別タブURL表示** (1466-1472, 1527-1533行目)
     - 変更: 各年度データの下に該当年度のURLを表示
     - URL名形式: `{項目名}({year}年)` でマッチング

  **analyzer.py:**
  1. **連続年数計算で年度欠落を考慮** (_calc_consecutive_wins)
     - 原因: 2022→2024と飛んでも連続とカウント
     - 修正: `prev_year` を追跡し `year == prev_year + 1` をチェック

  2. **スコア差分分析のNoneチェック** (504-508行目)
     - 原因: `if not score1` が0を除外
     - 修正: `if score1 is None or score2 is None`

  3. **評価項目支配率の母数計算** (530-578行目)
     - 原因: 空データを含む全項目数を母数に使用
     - 修正: `actual_items` で実データ数のみカウント

  4. **項目特徴分析のスコアチェック** (602-606行目)
     - 修正: `if score1 is not None and score2 is not None`

**問題6: 評価項目別/部門別 平均得点推移グラフが表示されない (v4.0で解決)**
- 症状: 歴代記録タブの「評価項目別 平均得点推移」「部門別 平均得点推移」グラフが表示されない
- **根本原因**: グラフ表示コード（1312-1376行目）が `if trends and trends.get("years"):` ブロック内にネストされていた
  - `trends`（総合ランキングの得点推移）が空の場合、評価項目別/部門別グラフも表示されなかった
- **修正内容** (v4.0):
  - 評価項目別/部門別グラフを `if trends` ブロックの外に移動
  - `import altair as alt` をグラフ描画直前に追加（スコープ対応）
  - エラーメッセージを改善（「データにスコアが含まれていません」を追加）

**問題7: 過去年度データが取得できない - サブパスありランキング (v4.1で解決)**
- 症状: 24時間ジム（_fitness/24hours）等で2025年のみ取得され、過去年度が取得できない
- **根本原因**: URL構造の誤り
  - 誤: `/rank_fitness/2024/24hours/`
  - 正: `/rank_fitness/24hours/2024/`
- **修正内容** (v4.1):
  - scraper.py: `/subpath/year/` 形式を優先、失敗時に `/year/subpath/` 形式をフォールバック
  - 部門別・評価項目別URLも同様に修正

**問題8: グラフが積み上げ縦棒になる (v4.1で解決)**
- 症状: 年度別比較グラフが積み上げ式で表示され、比較しづらい
- **修正内容** (v4.1):
  - Altair faceted chart (`column=alt.Column()`) を使用
  - 各評価項目/部門ごとに年度別棒グラフを横並びで表示

**問題9: セキュリティとネットワーク安定性 (v4.2で解決 - Geminiレビュー対応)**
- 修正箇所と内容:

  **app.py:**
  1. **トレースバック情報漏洩** (433-438行目)
     - 問題: エラー時にスタックトレースがユーザーに表示される
     - 修正: ログにのみ出力、ユーザーには一般的なエラーメッセージのみ表示

  2. **年度範囲のハードコード** (357-361行目)
     - 問題: `year > 2030` が将来機能しなくなる
     - 修正: `datetime.now().year + 5` で動的に計算

  3. **ロギング追加** (12-16行目)
     - 変更: logging設定を追加し、デバッグ情報をログに出力

  **scraper.py:**
  1. **リトライ処理追加** (155-171行目)
     - 問題: ネットワークエラー時に即座に失敗
     - 修正: `urllib3.util.retry.Retry` で500系エラー時に最大3回リトライ（バックオフ付き）

**問題10: 最新年度が未発表の場合に過去年度が取得できない (v4.3で解決)**
- 症状: 携帯キャリアで「2025年 ✅」「2024年 ❌」のように2024年が失敗扱いになる
- **根本原因**: `year == end_year` でトップページURLを使用していたが、実際のトップページは2024年のデータ
  - 2025年を要求 → トップページURL使用 → 実際には2024年データを取得
  - 2024年を要求 → /2024/ URL使用 → 存在しない（404）
- **修正内容** (v4.3):
  - `_detect_actual_year()` メソッド追加: トップページから実際の発表年度を検出
    - パターン1 (最優先): 最終更新日 `最終更新日：2025-11-01` から年度検出
    - パターン2: タイトル `2025年 オリコン顧客満足度` から年度検出
    - パターン3: ページ冒頭30行内の年度表記 `2025年 ネット証券` から年度検出
    - パターン4: 調査期間 `2024/05/24～2024/07/23` から年度検出
    - パターン5 (フォールバック): 過去リンク最大値 + 1 で推定（信頼性低）
  - 未発表年度（`year > actual_top_year`）は自動スキップ
  - トップページの年度と一致する年度のみ年度なしURLを使用
  - 検出した年度はキャッシュして再利用

  **v4.3.1 改善点（ネット証券対応）**:
  - 問題: ネット証券(rank_certificate)で2025年なのに2023年と誤検出
    - 原因: 過去リンクパターン(/2022/)から 2022+1=2023 と推定（年度が飛んでいる場合に不正確）
  - 解決: 最終更新日パターンを最優先に変更
    - `最終更新日：2025-11-01` → 正しく2025年を検出

  **テスト結果（携帯キャリア 2023-2025）**:
  ```
  2025  SKIP  -  (未発表)
  2024  OK    https://life.oricon.co.jp/rank-mobile-carrier/
  2023  OK    https://life.oricon.co.jp/rank-mobile-carrier/2023/
  ```

  **テスト結果（ネット証券 2023-2025）**:
  ```
  2025  OK    https://life.oricon.co.jp/rank_certificate/  (最終更新日から検出)
  2024  OK    https://life.oricon.co.jp/rank_certificate/2024/
  2023  OK    https://life.oricon.co.jp/rank_certificate/2023/
  ```

### 3. データ統合

```python
# アップロードデータが優先
merged = merge_data(uploaded_overall, scraped_overall)
```

- アップロード年度はスクレイピング対象から除外
- Webサイトの最新年度(2025)を超える年度はスクレイピングしない

### 4. 分析機能 (analyzer.py)

- **歴代記録分析**: 連続1位、過去最高得点、最多1位獲得
- **得点推移分析**: 年度別平均、企業別推移
- **TOPICS生成**: 重要トピックスの自動抽出、見出し案生成

**問題11: 同点の場合の分析が不適切 (v4.4で解決)**
- 症状: SBI証券(68.9点) vs 楽天証券(68.9点)の場合、「得点差わずか0.0点の僅差」と表示
- 問題: オリコンでは同点は「同率1位」として扱う（2位は存在しない）
- **修正内容** (v4.4):
  - `_analyze_score_difference()` メソッドを改善
  - 同点の企業をすべて検出し、「同率1位」として分析
  - impact値を5に設定（通常の得点差分析より重要度が高い）

  **対応パターン**:
  | ケース | 入力例 | 出力 |
  |--------|--------|------|
  | 2社同率1位 | SBI証券=楽天証券(68.9点) | 「SBI証券と楽天証券が同率1位」 |
  | 3社以上同率1位 | A社=B社=C社(70.0点) | 「3社が同率1位で並ぶ」 |
  | 僅差（0.5点以下） | 68.9点 vs 68.5点 | 「1位と2位の得点差わずか0.4点の僅差」 |
  | 大差（2点以上） | 70.0点 vs 67.5点 | 「1位と2位の得点差2.5点、SBI証券が大きく引き離す」 |

  **実装詳細** (`analyzer.py:508-533`):
  ```python
  # 同率1位のチェック: 同じ得点の企業をすべて収集
  tied_companies = [first["company"]]
  for entry in data[1:]:
      if entry.get("score") == score1:
          tied_companies.append(entry["company"])
      else:
          break  # 得点が異なる企業が出たらループ終了

  # 同率1位が2社以上の場合
  if len(tied_companies) >= 2:
      if len(tied_companies) == 2:
          return {
              "importance": "重要",
              "title": f"{tied_companies[0]}と{tied_companies[1]}が同率1位",
              "evidence": f"両社とも{score1}点で並ぶ",
              "impact": 5
          }
  ```

## UI機能

### 参考資料URL
- `st.column_config.LinkColumn`でクリック可能なリンクを表示
- 「🔗 リンクを開く」ボタンで直接ページを開ける

### グラフ
- 縦軸: 60-80（得点差が見やすいように調整）
- Altairを使用したインタラクティブなグラフ

## 使用方法

### 起動
```bash
cd streamlit-app
streamlit run app.py --server.port 8505
```

### 基本的な使い方
1. サイドバーでランキングを選択（例: FX（顧客満足度））
2. 過去データ取得範囲を選択
3. （オプション）最新のExcelファイルをアップロード
4. アップロードデータの年度を指定（例: 2026）
5. 「TOPICS出し実行」をクリック

### Excelファイルの要件
- 形式: .xlsx
- ヘッダー行に「順位」「ID」「ランキング対象企業名」を含むこと
- 得点は「スコア」「合計」「得点」列から取得

## トラブルシューティング

### 年度が異常な値になる
- 原因: 年度列の誤検出
- 対処: サイドバーで「アップロードデータの年度」を明示的に指定

### 部門名が「n＝ 100」になる
- v3.6で修正済み
- カテゴリ名がRow2から正しく取得されるようになった

### スクレイピングが失敗する
- ネットワーク接続を確認
- オリコンサイトの構造変更の可能性を確認
- `scraper.py`のセレクタを確認

**問題12: Multi-AIレビューによる大規模リファクタリング (v4.5で解決)**
- 実施: Perplexity（全ランキング調査）+ Gemini（コードレビュー×3ファイル）による包括的レビュー
- **発見された問題と修正**:

  **Critical修正:**
  1. **st.exception()のセキュリティリスク** (app.py:1101)
     - 問題: スタックトレースがユーザーに漏洩
     - 修正: `logger.error()`に変更、ユーザーには汎用エラーメッセージのみ表示

  2. **ゼロ除算エラー** (app.py:118)
     - 問題: `total_years=0`の場合に`ZeroDivisionError`
     - 修正: `if r['total_years'] > 0 else "0.0%"` の条件追加

  3. **年度検出ロジック簡素化** (scraper.py:202-270)
     - 問題: 調査期間パターンが不要（更新日が正式な年度基準）
     - 修正: 調査期間パターン削除、更新日優先のシンプルなロジックに

  **High修正:**
  1. **current_yearハードコード** (app.py:888)
     - 問題: `current_year = 2025` が将来機能しなくなる
     - 修正: `datetime.now().year` で動的取得

  2. **カテゴリフィルタ不足** (app.py:838)
     - 問題: 「外貨預金」「キャッシュレス決済」がフィルタにヒットしない
     - 修正: 金融カテゴリに「外貨」「決済」キーワード追加

  3. **_actual_top_year未初期化問題** (scraper.py)
     - 問題: `get_evaluation_items`/`get_departments`を単独呼び出し時にフォールバック値(2024)使用
     - 修正: `_ensure_actual_top_year()` ヘルパーメソッド追加、各メソッドで確実に初期化

  **追加された新ランキング（25件）:**
  - キャリア格安ブランド (`mobile-carrier/reasonable`)
  - プロバイダ地域別（9件）: 北海道、東北、北関東、首都圏、甲信越・北陸、東海、近畿、中国・四国、九州・沖縄
  - 動画配信ジャンル別（11件）: 国内ドラマ、海外ドラマ、韓国ドラマ、邦画、洋画、韓国映画、アニメ、キッズ・ファミリー、音楽、バラエティ、スポーツ
  - ウォーターサーバー（浄水型）、住宅ローン（FP評価）、パーソナルトレーニング、光回線10ギガ

  **年度検出の優先順位（v4.5）:**
  1. 最終更新日（最も信頼性が高い）← 例: `2024/12/02` → 2024年
  2. タイトルの年度表記
  3. ページ冒頭の年度表記
  4. 過去リンクからの推定（フォールバック）

  ※調査期間は使用しない（更新日が正式な年度基準のため）

## 今後の改善案

1. **複数年度Excelの対応**: 1ファイルで複数年度のデータを持つ形式
2. **キャッシュ機能**: スクレイピング結果のローカルキャッシュ
3. **比較機能**: 複数ランキング間の比較分析
4. **テンプレート出力**: プレスリリース用テキストの自動生成
5. **テスト追加**: 0値/None値を含むデータでの単体テスト
6. **型アノテーション**: Optional型の明示化（score: Optional[float]）

## 依存関係

```
streamlit>=1.28.0
pandas>=2.0.0
requests>=2.31.0
beautifulsoup4>=4.12.0
openpyxl>=3.1.0
xlsxwriter>=3.1.0
altair (streamlitに含まれる)
```

## 連絡先

本システムに関する質問は開発担当者まで。
