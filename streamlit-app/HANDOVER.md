# オリコン顧客満足度 TOPICSサポートシステム - 引継ぎ資料

## 概要

オリコン顧客満足度ランキングのプレスリリース作成を支援するStreamlitアプリケーション。
Webスクレイピングによる過去データ取得と、Excelファイルアップロードによる最新データ統合機能を持つ。

## バージョン履歴

| バージョン | 日付 | 主な変更点 |
|-----------|------|-----------|
| v3.9 | 2025-11-27 | バグ修正（0値判定、連続年数計算、グラフスコア、URL表示改善） |
| v3.8 | 2025-11-27 | UI改善（URL全文表示、タブ統合、評価項目別/部門別グラフ追加） |
| v3.7 | 2025-11-26 | 順位抽出ロジック修正（icon-rank優先、評価項目別テーブル除外） |
| v3.6 | 2025-11-25 | Excel抽出改善、URLリンク化、グラフ軸変更 |
| v3.5 | 2025-11-25 | 年度列誤検出防止、年度妥当性チェック |
| v3.4 | 2025-11-25 | Webサイト最新年度制限、デバッグログ追加 |
| v3.2 | 2025-11-25 | ファイルアップロード機能強化 |

## ファイル構成

```
streamlit-app/
├── app.py              # メインアプリケーション
├── scraper.py          # Webスクレイピングロジック
├── analyzer.py         # TOPICS分析・歴代記録分析
├── requirements.txt    # 依存パッケージ
├── HANDOVER.md         # 本引継ぎ資料
└── test/               # テストデータ
```

## 主要機能

### 1. Webスクレイピング (scraper.py)
- オリコン顧客満足度ランキングサイトからデータを取得
- URL構造:
  - 最新年度: `https://life.oricon.co.jp/rank-{slug}/`
  - 過去年度: `https://life.oricon.co.jp/rank-{slug}/{year}/`
- 対応ランキング: FX、携帯キャリア、格安SIM、証券、保険など

### 2. Excelファイル解析 (app.py: parse_uploaded_excel)

#### 対応フォーマット
オリコン内部Excelファイルの構造に対応:

```
Row 0: FX
Row 1: シート名（業態別、評価項目など）
Row 2: カテゴリ名（FX専業、スキャルピングトレードなど）
Row 3: n＝ 100（サンプルサイズ）
Row 4: 順位, ID, ランキング対象企業名, 回答者数, ...（ヘッダー）
Row 5〜: データ行
```

#### シート種別と処理

| シート種別 | 判定条件 | 抽出先 |
|-----------|---------|--------|
| 総合対象企業 | '総合' or '対象企業' in シート名 | overall_data |
| 評価項目 | '評価項目' in シート名 + 1列目が項目名 | item_data |
| 部門別 | '別' で終わるシート名 | dept_data |

#### 重要な修正点 (v3.5-3.7)

**問題1: 年度列の誤検出 (v3.5)**
- 原因: `回答者数（最新年）`列が「年」を含むため年度列として誤検出
- 修正: 除外パターンを追加 (`回答者数`, `最新年`, `前年` 等)
- 対策: 年度値が2000-2030の範囲外なら指定年度を使用

**問題2: 部門名の誤検出 (v3.6)**
- 原因: カテゴリ名検出が「n＝ 100」を拾っていた
- 修正: Row2を優先的に確認、`n＝`を含む行を除外

**問題3: 順位の誤取得 (v3.7)**
- 原因: 評価項目別テーブル内の `<img alt="2位">` を総合順位として誤取得
- 症状: Netflix(77点)が本来1位なのにDMM TV(75.3点)が1位と判定される
- 修正箇所: `scraper.py` の `_extract_ranking_data` メソッド
- 修正内容:
  1. `icon-rank` クラスを最優先で探索（総合順位の正しい表示場所）
  2. `td.rank` 内（評価項目別テーブル）の img を除外
  3. `ranking-score` セクション内の順位を除外
  4. 順位の範囲検証（1-100）を追加

**問題4: v3.8 UI改善 (2025-11-27)**
- 変更内容:
  1. URL表示を「リンクを開く」ボタンから全文URL表示に変更
  2. 見出し案タブを推奨TOPICSタブに統合（タブ数削減）
  3. 歴代記録タブに評価項目別/部門別の平均得点推移グラフを追加
  4. インパクト/最重要ラベルを推奨TOPICSから削除
  5. DataFrameから空白列や数字のみの列名を除外

**問題5: v3.9 バグ修正 (2025-11-27 - Codexレビュー指摘)**
- 修正箇所と内容:

  **app.py:**
  1. **0点/0位が空文字になるバグ** (77-78行目)
     - 原因: `score if score else ""` が0をfalsyとして扱う
     - 修正: `score if score is not None else ""`

  2. **ヘッダー検出条件の緩和** (235-241行目)
     - 原因: ID列必須条件が厳しすぎてシートをスキップ
     - 修正: 「順位」+「企業/ランキング/会社」で検出

  3. **セッション状態リセット** (902-903行目)
     - 原因: エラー後も前回結果が表示される
     - 修正: 実行開始時に `st.session_state.results_data = None`

  4. **グラフスコアフィルタリング** (1321, 1354行目)
     - 原因: `d.get("score")` が0を除外
     - 修正: `d.get("score") is not None`

  5. **評価項目別/部門別タブURL表示** (1466-1472, 1527-1533行目)
     - 変更: 各年度データの下に該当年度のURLを表示
     - URL名形式: `{項目名}({year}年)` でマッチング

  **analyzer.py:**
  1. **連続年数計算で年度欠落を考慮** (_calc_consecutive_wins)
     - 原因: 2022→2024と飛んでも連続とカウント
     - 修正: `prev_year` を追跡し `year == prev_year + 1` をチェック

  2. **スコア差分分析のNoneチェック** (504-508行目)
     - 原因: `if not score1` が0を除外
     - 修正: `if score1 is None or score2 is None`

  3. **評価項目支配率の母数計算** (530-578行目)
     - 原因: 空データを含む全項目数を母数に使用
     - 修正: `actual_items` で実データ数のみカウント

  4. **項目特徴分析のスコアチェック** (602-606行目)
     - 修正: `if score1 is not None and score2 is not None`

### 3. データ統合

```python
# アップロードデータが優先
merged = merge_data(uploaded_overall, scraped_overall)
```

- アップロード年度はスクレイピング対象から除外
- Webサイトの最新年度(2025)を超える年度はスクレイピングしない

### 4. 分析機能 (analyzer.py)

- **歴代記録分析**: 連続1位、過去最高得点、最多1位獲得
- **得点推移分析**: 年度別平均、企業別推移
- **TOPICS生成**: 重要トピックスの自動抽出、見出し案生成

## UI機能

### 参考資料URL
- `st.column_config.LinkColumn`でクリック可能なリンクを表示
- 「🔗 リンクを開く」ボタンで直接ページを開ける

### グラフ
- 縦軸: 60-80（得点差が見やすいように調整）
- Altairを使用したインタラクティブなグラフ

## 使用方法

### 起動
```bash
cd streamlit-app
streamlit run app.py --server.port 8505
```

### 基本的な使い方
1. サイドバーでランキングを選択（例: FX（顧客満足度））
2. 過去データ取得範囲を選択
3. （オプション）最新のExcelファイルをアップロード
4. アップロードデータの年度を指定（例: 2026）
5. 「TOPICS出し実行」をクリック

### Excelファイルの要件
- 形式: .xlsx
- ヘッダー行に「順位」「ID」「ランキング対象企業名」を含むこと
- 得点は「スコア」「合計」「得点」列から取得

## トラブルシューティング

### 年度が異常な値になる
- 原因: 年度列の誤検出
- 対処: サイドバーで「アップロードデータの年度」を明示的に指定

### 部門名が「n＝ 100」になる
- v3.6で修正済み
- カテゴリ名がRow2から正しく取得されるようになった

### スクレイピングが失敗する
- ネットワーク接続を確認
- オリコンサイトの構造変更の可能性を確認
- `scraper.py`のセレクタを確認

## 今後の改善案

1. **複数年度Excelの対応**: 1ファイルで複数年度のデータを持つ形式
2. **キャッシュ機能**: スクレイピング結果のローカルキャッシュ
3. **比較機能**: 複数ランキング間の比較分析
4. **テンプレート出力**: プレスリリース用テキストの自動生成
5. **テスト追加**: 0値/None値を含むデータでの単体テスト
6. **型アノテーション**: Optional型の明示化（score: Optional[float]）

## 依存関係

```
streamlit>=1.28.0
pandas>=2.0.0
requests>=2.31.0
beautifulsoup4>=4.12.0
openpyxl>=3.1.0
xlsxwriter>=3.1.0
altair (streamlitに含まれる)
```

## 連絡先

本システムに関する質問は開発担当者まで。
