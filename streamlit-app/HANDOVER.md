# オリコン顧客満足度 TOPICSサポートシステム - 引継ぎ資料

## 概要

オリコン顧客満足度ランキングのプレスリリース作成を支援するStreamlitアプリケーション。
Webスクレイピングによる過去データ取得と、Excelファイルアップロードによる最新データ統合機能を持つ。

## バージョン履歴

| バージョン | 日付 | 主な変更点 |
|-----------|------|-----------|
| v5.8 | 2025-12-01 | 推奨TOPICS拡充（評価項目別・部門別の連続1位記録、部門独占状況、得点差分析を追加） |
| v5.7 | 2025-12-01 | 全215ランキング包括的テスト・修正（医療保険URL修正、バイク販売店/電子コミック/映画館/テーマパーク部門検出追加、Critical問題修正） |
| v5.6 | 2025-12-01 | FX部門別ランキング検出修正（style追加、タイトル抽出パターン追加で初心者/スキャルピング等9部門を検出可能に） |
| v5.5 | 2025-11-28 | 棒グラフ改善（mark_rectによる非0基点実装で差分が見やすく、サイズ拡大: height 200→350, width 80→100）、顧客満足度/FP評価の分離対応（#1/#2ハッシュによるURL区別）、警告文言簡素化 |
| v5.4 | 2025-11-28 | 名称変更検出改善（ページタイトルから実際の評価項目名・部門名を取得、最新名称をexpanderタイトルに表示） |
| v5.3 | 2025-11-28 | アップロード機能の隠し化（環境変数 ENABLE_UPLOAD_FEATURE で制御、Cloud環境ではデフォルト非表示） |
| v5.2 | 2025-11-28 | グラフ機能拡張（折れ線グラフをTOP10全企業の経年推移に変更、縦棒グラフの縦軸を動的に設計：データ範囲に応じてmin-2〜max+2で自動調整） |
| v5.1 | 2025-11-28 | 名称変更検出機能（評価項目・部門の名称が途中で変更された場合「●●年から〜に変更」と注記表示） |
| v5.0 | 2025-11-28 | グラフ機能強化（総合得点の年表記横にURL配置、各年度の表の下に縦棒グラフ追加、経年変化の折れ線グラフを「1位の推移」の下に配置） |
| v4.9 | 2025-11-28 | 総合ランキングタブに1位獲得回数ランキングを追加（評価項目別・部門別と同様のロジック） |
| v4.8 | 2025-11-28 | 透明性向上: サイドバー左下に更新履歴を折りたたみ表示（HANDOVER.mdから動的読み込み） |
| v4.7 | 2025-11-28 | 8件の改善要望対応（連続記録ロジック修正、1位獲得回数ランキング改善、URL表示位置変更、参考資料タブURL有効化、連続1位記録表示条件変更、推奨TOPICS根拠削除、ツール上部記載変更、UIレイアウト変更） |
| v4.6 | 2025-11-27 | 1位獲得回数表示拡充（評価項目別・部門別タブに1位獲得回数ランキングを追加、年度検出ロジック修正：更新日を年度基準として使用） |
| v4.5 | 2025-11-27 | Multi-AIレビュー対応（25件の漏れランキング追加、Critical/Highバグ修正、コードリファクタリング） |
| v4.4 | 2025-11-27 | 同率順位対応（同点の場合「同率1位」として分析、2社/3社以上にも対応） |
| v4.3 | 2025-11-27 | 動的年度検出（トップページから実際の発表年度を自動判定、未発表年度スキップ） |
| v4.2 | 2025-11-27 | コードレビュー対応（セキュリティ改善、リトライ処理追加、動的年度範囲） |
| v4.1 | 2025-11-27 | 過去年度URL修正（/subpath/year/形式優先）、Altair faceted chartでグラフ表示 |
| v4.0 | 2025-11-27 | グラフ表示修正（評価項目別/部門別グラフがtrendsの有無に関わらず表示） |
| v3.9 | 2025-11-27 | バグ修正（0値判定、連続年数計算、グラフスコア、URL表示改善） |
| v3.8 | 2025-11-27 | UI改善（URL全文表示、タブ統合、評価項目別/部門別グラフ追加） |
| v3.7 | 2025-11-26 | 順位抽出ロジック修正（icon-rank優先、評価項目別テーブル除外） |
| v3.6 | 2025-11-25 | Excel抽出改善、URLリンク化、グラフ軸変更 |
| v3.5 | 2025-11-25 | 年度列誤検出防止、年度妥当性チェック |
| v3.4 | 2025-11-25 | Webサイト最新年度制限、デバッグログ追加 |
| v3.2 | 2025-11-25 | ファイルアップロード機能強化 |

## ファイル構成

```
streamlit-app/
├── app.py              # メインアプリケーション
├── scraper.py          # Webスクレイピングロジック
├── analyzer.py         # TOPICS分析・歴代記録分析
├── requirements.txt    # 依存パッケージ
├── HANDOVER.md         # 本引継ぎ資料
└── test/               # テストデータ
```

## 主要機能

### 1. Webスクレイピング (scraper.py)
- オリコン顧客満足度ランキングサイトからデータを取得
- URL構造:
  - 最新年度: `https://life.oricon.co.jp/rank-{slug}/`
  - 過去年度: `https://life.oricon.co.jp/rank-{slug}/{year}/`
- 対応ランキング: FX、携帯キャリア、格安SIM、証券、保険など

### 2. Excelファイル解析 (app.py: parse_uploaded_excel)

#### 対応フォーマット
オリコン内部Excelファイルの構造に対応:

```
Row 0: FX
Row 1: シート名（業態別、評価項目など）
Row 2: カテゴリ名（FX専業、スキャルピングトレードなど）
Row 3: n＝ 100（サンプルサイズ）
Row 4: 順位, ID, ランキング対象企業名, 回答者数, ...（ヘッダー）
Row 5〜: データ行
```

#### シート種別と処理

| シート種別 | 判定条件 | 抽出先 |
|-----------|---------|--------|
| 総合対象企業 | '総合' or '対象企業' in シート名 | overall_data |
| 評価項目 | '評価項目' in シート名 + 1列目が項目名 | item_data |
| 部門別 | '別' で終わるシート名 | dept_data |

#### 重要な修正点 (v3.5-3.7)

**問題1: 年度列の誤検出 (v3.5)**
- 原因: `回答者数（最新年）`列が「年」を含むため年度列として誤検出
- 修正: 除外パターンを追加 (`回答者数`, `最新年`, `前年` 等)
- 対策: 年度値が2000-2030の範囲外なら指定年度を使用

**問題2: 部門名の誤検出 (v3.6)**
- 原因: カテゴリ名検出が「n＝ 100」を拾っていた
- 修正: Row2を優先的に確認、`n＝`を含む行を除外

**問題3: 順位の誤取得 (v3.7)**
- 原因: 評価項目別テーブル内の `<img alt="2位">` を総合順位として誤取得
- 症状: Netflix(77点)が本来1位なのにDMM TV(75.3点)が1位と判定される
- 修正箇所: `scraper.py` の `_extract_ranking_data` メソッド
- 修正内容:
  1. `icon-rank` クラスを最優先で探索（総合順位の正しい表示場所）
  2. `td.rank` 内（評価項目別テーブル）の img を除外
  3. `ranking-score` セクション内の順位を除外
  4. 順位の範囲検証（1-100）を追加

**問題4: v3.8 UI改善 (2025-11-27)**
- 変更内容:
  1. URL表示を「リンクを開く」ボタンから全文URL表示に変更
  2. 見出し案タブを推奨TOPICSタブに統合（タブ数削減）
  3. 歴代記録タブに評価項目別/部門別の平均得点推移グラフを追加
  4. インパクト/最重要ラベルを推奨TOPICSから削除
  5. DataFrameから空白列や数字のみの列名を除外

**問題5: v3.9 バグ修正 (2025-11-27 - Codexレビュー指摘)**
- 修正箇所と内容:

  **app.py:**
  1. **0点/0位が空文字になるバグ** (77-78行目)
     - 原因: `score if score else ""` が0をfalsyとして扱う
     - 修正: `score if score is not None else ""`

  2. **ヘッダー検出条件の緩和** (235-241行目)
     - 原因: ID列必須条件が厳しすぎてシートをスキップ
     - 修正: 「順位」+「企業/ランキング/会社」で検出

  3. **セッション状態リセット** (902-903行目)
     - 原因: エラー後も前回結果が表示される
     - 修正: 実行開始時に `st.session_state.results_data = None`

  4. **グラフスコアフィルタリング** (1321, 1354行目)
     - 原因: `d.get("score")` が0を除外
     - 修正: `d.get("score") is not None`

  5. **評価項目別/部門別タブURL表示** (1466-1472, 1527-1533行目)
     - 変更: 各年度データの下に該当年度のURLを表示
     - URL名形式: `{項目名}({year}年)` でマッチング

  **analyzer.py:**
  1. **連続年数計算で年度欠落を考慮** (_calc_consecutive_wins)
     - 原因: 2022→2024と飛んでも連続とカウント
     - 修正: `prev_year` を追跡し `year == prev_year + 1` をチェック

  2. **スコア差分分析のNoneチェック** (504-508行目)
     - 原因: `if not score1` が0を除外
     - 修正: `if score1 is None or score2 is None`

  3. **評価項目支配率の母数計算** (530-578行目)
     - 原因: 空データを含む全項目数を母数に使用
     - 修正: `actual_items` で実データ数のみカウント

  4. **項目特徴分析のスコアチェック** (602-606行目)
     - 修正: `if score1 is not None and score2 is not None`

**問題6: 評価項目別/部門別 平均得点推移グラフが表示されない (v4.0で解決)**
- 症状: 歴代記録タブの「評価項目別 平均得点推移」「部門別 平均得点推移」グラフが表示されない
- **根本原因**: グラフ表示コード（1312-1376行目）が `if trends and trends.get("years"):` ブロック内にネストされていた
  - `trends`（総合ランキングの得点推移）が空の場合、評価項目別/部門別グラフも表示されなかった
- **修正内容** (v4.0):
  - 評価項目別/部門別グラフを `if trends` ブロックの外に移動
  - `import altair as alt` をグラフ描画直前に追加（スコープ対応）
  - エラーメッセージを改善（「データにスコアが含まれていません」を追加）

**問題7: 過去年度データが取得できない - サブパスありランキング (v4.1で解決)**
- 症状: 24時間ジム（_fitness/24hours）等で2025年のみ取得され、過去年度が取得できない
- **根本原因**: URL構造の誤り
  - 誤: `/rank_fitness/2024/24hours/`
  - 正: `/rank_fitness/24hours/2024/`
- **修正内容** (v4.1):
  - scraper.py: `/subpath/year/` 形式を優先、失敗時に `/year/subpath/` 形式をフォールバック
  - 部門別・評価項目別URLも同様に修正

**問題8: グラフが積み上げ縦棒になる (v4.1で解決)**
- 症状: 年度別比較グラフが積み上げ式で表示され、比較しづらい
- **修正内容** (v4.1):
  - Altair faceted chart (`column=alt.Column()`) を使用
  - 各評価項目/部門ごとに年度別棒グラフを横並びで表示

**問題9: セキュリティとネットワーク安定性 (v4.2で解決 - Geminiレビュー対応)**
- 修正箇所と内容:

  **app.py:**
  1. **トレースバック情報漏洩** (433-438行目)
     - 問題: エラー時にスタックトレースがユーザーに表示される
     - 修正: ログにのみ出力、ユーザーには一般的なエラーメッセージのみ表示

  2. **年度範囲のハードコード** (357-361行目)
     - 問題: `year > 2030` が将来機能しなくなる
     - 修正: `datetime.now().year + 5` で動的に計算

  3. **ロギング追加** (12-16行目)
     - 変更: logging設定を追加し、デバッグ情報をログに出力

  **scraper.py:**
  1. **リトライ処理追加** (155-171行目)
     - 問題: ネットワークエラー時に即座に失敗
     - 修正: `urllib3.util.retry.Retry` で500系エラー時に最大3回リトライ（バックオフ付き）

**問題10: 最新年度が未発表の場合に過去年度が取得できない (v4.3で解決)**
- 症状: 携帯キャリアで「2025年 ✅」「2024年 ❌」のように2024年が失敗扱いになる
- **根本原因**: `year == end_year` でトップページURLを使用していたが、実際のトップページは2024年のデータ
  - 2025年を要求 → トップページURL使用 → 実際には2024年データを取得
  - 2024年を要求 → /2024/ URL使用 → 存在しない（404）
- **修正内容** (v4.3):
  - `_detect_actual_year()` メソッド追加: トップページから実際の発表年度を検出
    - パターン1 (最優先): 最終更新日 `最終更新日：2025-11-01` から年度検出
    - パターン2: タイトル `2025年 オリコン顧客満足度` から年度検出
    - パターン3: ページ冒頭30行内の年度表記 `2025年 ネット証券` から年度検出
    - パターン4: 調査期間 `2024/05/24～2024/07/23` から年度検出
    - パターン5 (フォールバック): 過去リンク最大値 + 1 で推定（信頼性低）
  - 未発表年度（`year > actual_top_year`）は自動スキップ
  - トップページの年度と一致する年度のみ年度なしURLを使用
  - 検出した年度はキャッシュして再利用

  **v4.3.1 改善点（ネット証券対応）**:
  - 問題: ネット証券(rank_certificate)で2025年なのに2023年と誤検出
    - 原因: 過去リンクパターン(/2022/)から 2022+1=2023 と推定（年度が飛んでいる場合に不正確）
  - 解決: 最終更新日パターンを最優先に変更
    - `最終更新日：2025-11-01` → 正しく2025年を検出

  **テスト結果（携帯キャリア 2023-2025）**:
  ```
  2025  SKIP  -  (未発表)
  2024  OK    https://life.oricon.co.jp/rank-mobile-carrier/
  2023  OK    https://life.oricon.co.jp/rank-mobile-carrier/2023/
  ```

  **テスト結果（ネット証券 2023-2025）**:
  ```
  2025  OK    https://life.oricon.co.jp/rank_certificate/  (最終更新日から検出)
  2024  OK    https://life.oricon.co.jp/rank_certificate/2024/
  2023  OK    https://life.oricon.co.jp/rank_certificate/2023/
  ```

### 3. データ統合

```python
# アップロードデータが優先
merged = merge_data(uploaded_overall, scraped_overall)
```

- アップロード年度はスクレイピング対象から除外
- Webサイトの最新年度(2025)を超える年度はスクレイピングしない

### 4. 分析機能 (analyzer.py)

- **歴代記録分析**: 連続1位、過去最高得点、最多1位獲得
- **得点推移分析**: 年度別平均、企業別推移
- **TOPICS生成**: 重要トピックスの自動抽出、見出し案生成

**問題11: 同点の場合の分析が不適切 (v4.4で解決)**
- 症状: SBI証券(68.9点) vs 楽天証券(68.9点)の場合、「得点差わずか0.0点の僅差」と表示
- 問題: オリコンでは同点は「同率1位」として扱う（2位は存在しない）
- **修正内容** (v4.4):
  - `_analyze_score_difference()` メソッドを改善
  - 同点の企業をすべて検出し、「同率1位」として分析
  - impact値を5に設定（通常の得点差分析より重要度が高い）

  **対応パターン**:
  | ケース | 入力例 | 出力 |
  |--------|--------|------|
  | 2社同率1位 | SBI証券=楽天証券(68.9点) | 「SBI証券と楽天証券が同率1位」 |
  | 3社以上同率1位 | A社=B社=C社(70.0点) | 「3社が同率1位で並ぶ」 |
  | 僅差（0.5点以下） | 68.9点 vs 68.5点 | 「1位と2位の得点差わずか0.4点の僅差」 |
  | 大差（2点以上） | 70.0点 vs 67.5点 | 「1位と2位の得点差2.5点、SBI証券が大きく引き離す」 |

  **実装詳細** (`analyzer.py:508-533`):
  ```python
  # 同率1位のチェック: 同じ得点の企業をすべて収集
  tied_companies = [first["company"]]
  for entry in data[1:]:
      if entry.get("score") == score1:
          tied_companies.append(entry["company"])
      else:
          break  # 得点が異なる企業が出たらループ終了

  # 同率1位が2社以上の場合
  if len(tied_companies) >= 2:
      if len(tied_companies) == 2:
          return {
              "importance": "重要",
              "title": f"{tied_companies[0]}と{tied_companies[1]}が同率1位",
              "evidence": f"両社とも{score1}点で並ぶ",
              "impact": 5
          }
  ```

## UI機能

### 参考資料URL
- `st.column_config.LinkColumn`でクリック可能なリンクを表示
- 「🔗 リンクを開く」ボタンで直接ページを開ける

### グラフ
- **棒グラフ (v5.5)**: `mark_rect`による非0基点実装
  - Altairの`mark_bar`は設計上、常に0を基点として描画される仕様
  - `domain=[min, max]`や`zero=False`では棒の基点は変わらない（仕様）
  - 解決策: `mark_rect`で`y`(基点)と`y2`(得点)を明示指定
  - 得点範囲: 最小値-5 〜 最大値+2（差分を見やすく）
  - サイズ: height=350/400, width=100（従来比1.5-2倍）
- **折れ線グラフ**: TOP10企業の経年推移を表示
- Altairを使用したインタラクティブなグラフ

## 使用方法

### 起動
```bash
cd streamlit-app
streamlit run app.py --server.port 8505
```

### 基本的な使い方
1. サイドバーでランキングを選択（例: FX（顧客満足度））
2. 過去データ取得範囲を選択
3. （オプション）最新のExcelファイルをアップロード
4. アップロードデータの年度を指定（例: 2026）
5. 「TOPICS出し実行」をクリック

### Excelファイルの要件
- 形式: .xlsx
- ヘッダー行に「順位」「ID」「ランキング対象企業名」を含むこと
- 得点は「スコア」「合計」「得点」列から取得

## トラブルシューティング

### 年度が異常な値になる
- 原因: 年度列の誤検出
- 対処: サイドバーで「アップロードデータの年度」を明示的に指定

### 部門名が「n＝ 100」になる
- v3.6で修正済み
- カテゴリ名がRow2から正しく取得されるようになった

### スクレイピングが失敗する
- ネットワーク接続を確認
- オリコンサイトの構造変更の可能性を確認
- `scraper.py`のセレクタを確認

**問題12: Multi-AIレビューによる大規模リファクタリング (v4.5で解決)**
- 実施: Perplexity（全ランキング調査）+ Gemini（コードレビュー×3ファイル）による包括的レビュー
- **発見された問題と修正**:

  **Critical修正:**
  1. **st.exception()のセキュリティリスク** (app.py:1101)
     - 問題: スタックトレースがユーザーに漏洩
     - 修正: `logger.error()`に変更、ユーザーには汎用エラーメッセージのみ表示

  2. **ゼロ除算エラー** (app.py:118)
     - 問題: `total_years=0`の場合に`ZeroDivisionError`
     - 修正: `if r['total_years'] > 0 else "0.0%"` の条件追加

  3. **年度検出ロジック簡素化** (scraper.py:202-270)
     - 問題: 調査期間パターンが不要（更新日が正式な年度基準）
     - 修正: 調査期間パターン削除、更新日優先のシンプルなロジックに

  **High修正:**
  1. **current_yearハードコード** (app.py:888)
     - 問題: `current_year = 2025` が将来機能しなくなる
     - 修正: `datetime.now().year` で動的取得

  2. **カテゴリフィルタ不足** (app.py:838)
     - 問題: 「外貨預金」「キャッシュレス決済」がフィルタにヒットしない
     - 修正: 金融カテゴリに「外貨」「決済」キーワード追加

  3. **_actual_top_year未初期化問題** (scraper.py)
     - 問題: `get_evaluation_items`/`get_departments`を単独呼び出し時にフォールバック値(2024)使用
     - 修正: `_ensure_actual_top_year()` ヘルパーメソッド追加、各メソッドで確実に初期化

  **追加された新ランキング（25件）:**
  - キャリア格安ブランド (`mobile-carrier/reasonable`)
  - プロバイダ地域別（9件）: 北海道、東北、北関東、首都圏、甲信越・北陸、東海、近畿、中国・四国、九州・沖縄
  - 動画配信ジャンル別（11件）: 国内ドラマ、海外ドラマ、韓国ドラマ、邦画、洋画、韓国映画、アニメ、キッズ・ファミリー、音楽、バラエティ、スポーツ
  - ウォーターサーバー（浄水型）、住宅ローン（FP評価）、パーソナルトレーニング、光回線10ギガ

  **年度検出の優先順位（v4.5）:**
  1. 最終更新日（最も信頼性が高い）← 例: `2024/12/02` → 2024年
  2. タイトルの年度表記
  3. ページ冒頭の年度表記
  4. 過去リンクからの推定（フォールバック）

  ※調査期間は使用しない（更新日が正式な年度基準のため）

**問題13: FX部門別ランキングが検出されない (v5.6で解決)**
- 症状: FXランキングで部門別（初心者、スキャルピングトレード等）が0件と表示される
- **根本原因**: 2つの問題があった

  1. **`dept_patterns`に`style`が含まれていなかった** (scraper.py:573)
     - FXには「取引スタイル別」（style/）のカテゴリがあるが、パターンに含まれていなかった
     - 修正: `style` をパターンに追加
     ```python
     # 変更前
     dept_patterns = [
         r"/(age|genre|contract|new-contract|device|business|beginner|type|purpose|nisa|ideco)(?:/|\.html)",
     ]
     # 変更後
     dept_patterns = [
         r"/(age|genre|contract|new-contract|device|business|beginner|type|purpose|nisa|ideco|style)(?:/|\.html)",
     ]
     ```

  2. **`_extract_dept_name_from_title`のパターンが不足** (scraper.py:791-890)
     - FXページのタイトル形式「【2025年】FXの初心者ランキング・比較」に対応していなかった
     - 既存パターン: 「XXX向けの」「XXXにおすすめの」のみ
     - 修正: 新パターン追加
     ```python
     # パターン0.5: 【年度】XXXのYYYランキング → YYY を抽出（FX向け）
     # 例: 【2025年】FXの初心者ランキング・比較 → 初心者
     # 例: 【2025年】FXのスキャルピングトレードランキング・比較 → スキャルピングトレード
     match = re.search(r"】[^\s【】]+の(.+?)ランキング", text)
     if match:
         dept_name = match.group(1).strip()
         if dept_name and dept_name not in ["顧客満足度", "オリコン顧客満足度", "満足度"] and len(dept_name) <= 20:
             return dept_name
     ```

  **修正後の検出結果（9部門）**:
  - 初心者 (`beginner/`)
  - PC (`device/`)
  - スマホアプリ (`device/app.html`)
  - FX専業者 (`business/`)
  - 証券会社 (`business/securities.html`)
  - スキャルピングトレード (`style/`)
  - デイトレード (`style/day-trading.html`)
  - スイングトレード (`style/swing-trading.html`)
  - スワップトレード (`style/swap-trading.html`)

  **テスト結果**:
  - 部門URL成功: 18件（100%）
  - 評価項目URL成功: 18件
  - 総合ランキング: 2024年、2025年ともに取得成功

  **補足: 総合ランキングの年毎URLについて**
  - ユーザー報告: 「総合ランキングタブの年毎のURLが機能していない」
  - 調査結果: `https://life.oricon.co.jp/rank_fx/2024/` は正常にアクセス可能
  - 原因: トップページから過去年度へのリンクがないだけで、URLパターン自体は正しく動作していた
  - 結論: 実際には問題なし（年度別データは正常に取得できている）

**問題14: 全215ランキング包括的テスト・コード品質改善 (v5.7で解決)**
- 実施: Perplexity（サイト構造調査）+ Gemini（コードレビュー）+ Claude Opus 4.5（統合・最終判断・包括テスト実行）
- **テスト範囲**: **全215種類のランキング**（ranking_options定義全件）

  **修正内容一覧:**

  **1. Critical修正 (3件):**
  - **サイレントエラーハンドリング**: `try-except-pass` → `logger.warning()` でエラー記録
  - **危険なデフォルト評価項目**: 携帯キャリア項目の自動適用を削除
  - **汎用すぎるパターン0**: 短いテキスト → 既知の部門名ホワイトリスト方式

  **2. URL修正 (1件):**
  - **医療保険(medical_insurance)**: `rank-medical_insurance` → `medical_insurance`（rankプレフィックスなし）
  - `NO_RANK_PREFIX` リストを新設、URLパターン分岐を追加

  **3. 部門検出パターン追加 (5件):**
  - `sim|sp`: 格安SIM（mvno）
  - `specialty|manufacturer`: バイク販売店
  - `general|publisher|original`: 電子コミック/マンガアプリ
  - `hokkaido|tohoku|kanto|kinki|tokai|...`: 地域別（映画館、プロバイダ等）
  - `east|west`: テーマパーク

  **最終テスト結果 (v5.7)**:
  | ステータス | 件数 | 詳細 |
  |-----------|------|------|
  | OK | **215** | 全ランキングで部門または評価項目が正常検出 |
  | WARN | **0** | 問題なし |
  | Error | **0** | エラーなし |

  **検出統計**:
  | 検出パターン | 件数 |
  |-------------|------|
  | 部門+評価項目あり | 158件 |
  | 部門のみ | 6件 |
  | 評価項目のみ | 51件 |
  | どちらもなし | **0件** |

  **テストファイル**:
  - `test_all_rankings_comprehensive.py`: 全ランキング自動テストスクリプト
  - `test_report_comprehensive.json`: 詳細レポート（JSON形式）

**問題15: 推奨TOPICSの拡充 (v5.8で対応)**
- 要望: 総合ランキングだけでなく、評価項目別・部門別の連続記録や得点にもフォーカスしたい
- **拡張内容**:

  **1. TopicsAnalyzerの拡張:**
  - コンストラクタに `dept_data` 引数を追加（後方互換性維持）
  - 新規分析メソッド4件を追加

  **2. 追加された分析機能:**
  | メソッド名 | 分析内容 | 対象 |
  |-----------|---------|------|
  | `_analyze_item_consecutive_wins()` | 評価項目別の連続1位記録 | 3年以上連続 |
  | `_analyze_dept_consecutive_wins()` | 部門別の連続1位記録 | 3年以上連続 |
  | `_analyze_dept_dominance()` | 部門別の独占状況 | 60%以上 or 3部門以上 |
  | `_analyze_dept_features()` | 部門別の得点差分析 | 2位と3点差以上 |

  **3. TOPICS出力例（テストデータ）:**
  ```
  1. [総合] A社が3年連続で総合1位を達成 (impact: 5)
  2. [総合] 1位と2位の得点差3.0点、A社が大きく引き離す (impact: 4)
  3. [総合] A社が2項目中2項目で1位を独占 (impact: 4)
  4. [評価項目別] 『料金プラン』でA社が3年連続1位 (impact: 3)
  5. [部門別] 『30代』部門でA社が3年連続1位 (impact: 3)
  6. [部門別] 『40代』部門でB社が3年連続1位 (impact: 3)
  ```

  **4. impactスコア設計:**
  | 種別 | impact | 条件 |
  |------|--------|------|
  | 総合連続1位 | 5 | 2年以上連続 |
  | 総合得点差（大差） | 4 | 2点以上 |
  | 評価項目/部門独占 | 4 | 60%以上 |
  | 評価項目連続1位 | 3-4 | 3年で3, 5年以上で4 |
  | 部門連続1位 | 3-4 | 3年で3, 5年以上で4 |
  | 部門1位複数獲得 | 3 | 3部門以上 |

  **5. 修正ファイル:**
  - `analyzer.py`: TopicsAnalyzerクラスを拡張（4メソッド追加）
  - `app.py`: TopicsAnalyzer呼び出し時に`dept_data`を渡すよう修正

## 今後の改善案

1. **複数年度Excelの対応**: 1ファイルで複数年度のデータを持つ形式
2. **キャッシュ機能**: スクレイピング結果のローカルキャッシュ
3. **比較機能**: 複数ランキング間の比較分析
4. **テンプレート出力**: プレスリリース用テキストの自動生成
5. **テスト追加**: 0値/None値を含むデータでの単体テスト
6. **型アノテーション**: Optional型の明示化（score: Optional[float]）

## 依存関係

```
streamlit>=1.28.0
pandas>=2.0.0
requests>=2.31.0
beautifulsoup4>=4.12.0
openpyxl>=3.1.0
xlsxwriter>=3.1.0
altair (streamlitに含まれる)
```

## 連絡先

本システムに関する質問は開発担当者まで。

---

## 次回セッション向け改善要望（2025-11-27登録） → **v4.7で全件解決済み**

以下の8件の改善要望は、v4.7（2025-11-28）で全て対応完了しました。

### ✅ 1. 連続記録ロジックの修正【重要】
- **問題**: 携帯キャリアでdocomoが「9年連続通信速度1位（2015〜2023）」と表示されるが、実際は2016〜2021年は発表されていない
- **修正内容**: 連続記録は「発表回数」を基準にする（未発表年度をスキップして連続とカウント）
- **対象ファイル**: `analyzer.py` の `_calc_consecutive_wins` メソッド
- **対応日**: 2025-11-28

### ✅ 2. 1位獲得回数ランキングの改善
- **並び替え**: 評価項目別・部門別の1位獲得回数ランキングを、1位回数の多い順にソート
- **継続中表示**: 獲得回数ランキング内に「継続中」フラグ（最新年度も1位なら✅表示）を追加
- **対象ファイル**: `app.py` タブ4, タブ5の表示部分
- **対応日**: 2025-11-28

### ✅ 3. URL表示位置の変更
- **変更内容**: 年度の横にURL表示
  ```
  2024年 🔗 https://...
  ランキング表
  ```
- **対象ファイル**: `app.py` タブ4, タブ5のURL表示部分
- **対応日**: 2025-11-28

### ✅ 4. 参考資料タブのURL有効化
- **修正内容**: `st.column_config.LinkColumn` を使用してクリック可能なリンクに変更
- **対象ファイル**: `app.py` タブ6
- **対応日**: 2025-11-28

### ✅ 5. 連続1位記録の表示条件変更
- **条件変更**: 複数回1位を獲得したもののみ対象（1年だけの受賞は除外）
- **件数拡充**: 上位5件 → 上位10件に拡充
- **対象ファイル**: `app.py` タブ2, タブ4, タブ5の連続1位記録セクション、`display_consecutive_wins_compact` 関数
- **対応日**: 2025-11-28

### ✅ 6. 推奨TOPICSの根拠削除
- **修正内容**: 推奨TOPICSセクションから根拠説明（`- **根拠**: ...`）を削除
- **対象ファイル**: `app.py` タブ1
- **対応日**: 2025-11-28

### ✅ 7. ツール上部の記載変更
- **変更後**:
  ```
  📰 オリコン顧客満足度®調査 TOPICSサポートシステム
  オリコン顧客満足度調査の経年結果を調査。連続記録や1位獲得回数の参照に活用いただけます。
  ⚠️ 注意事項: 情報の正確性は担当者が必ず確認してください。未公開情報を含んだエクセル等はアップロードしないでください。
  ```
- **対象ファイル**: `app.py` 行545-547付近
- **対応日**: 2025-11-28

### ✅ 8. UIレイアウト変更
- **Excelアップロード**: `st.sidebar.expander` で折りたたみ式に変更（非推奨機能のため）
- **実行ボタン移動**: 「TOPICS出し実行」ボタンを「過去データ取得範囲」の直下に移動
- **対象ファイル**: `app.py` サイドバー部分
- **対応日**: 2025-11-28
