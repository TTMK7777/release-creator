# オリコン顧客満足度 TOPICSサポートシステム - 引継ぎ資料

## 概要

オリコン顧客満足度ランキングのプレスリリース作成を支援するStreamlitアプリケーション。
Webスクレイピングによる過去データ取得と、Excelファイルアップロードによる最新データ統合機能を持つ。

## バージョン履歴

| バージョン | 日付 | 主な変更点 |
|-----------|------|-----------|
| v8.4 | 2026-01-23 | **プレスリリース作成機能強化（release_tab.py v1.2）**: (1) **ワンクリック生成機能** - Excel + スクレイピングデータ → Word出力を1クリックで完結。ハイライト・本文からHEADLINE/SUBHEADLINE/TOPICSを自動マッピング。出力オプション（総合表/前年比較/評価項目別/部門別）選択可能。(2) **文章→Word自動連携強化** - 「文章を生成」実行時に自動でWord出力タブに反映（手動「再反映」ボタン不要に）、年度の自動同期、トースト通知追加。操作ステップ5回→1回に短縮 |
| v8.3 | 2026-01-21 | **改善点メモ対応（Multi-AIレビュー済）**: (1) 社名正規化の汎用化 - 括弧と中身を自動除去（Oisix（おいしっくすくらぶ）→Oisix、外貨ex byGMO（旧:YJFX!）→外貨ex byGMO等）、正規表現のモジュールレベルコンパイルでパフォーマンス向上。(2) 同点1位表示改善 - 「1位の推移」で同点企業を「A社 / B社」形式で全て表示。(3) 折り畳み表示を常時展開に変更（expanded=True）- 総合/評価項目別/部門別の一覧性向上。(4) Geminiレビュー指摘対応 - None/空チェック強化、型チェック追加 |
| v8.2 | 2025-12-17 | **Word出力機能v3.0**: (1) word_generator.py大幅アップグレード - 複数表の動的挿入（総合ランキング・前年比較・評価項目別・部門別）、企業別プレースホルダー対応（{{RANK_1_COMPANY}}等TOP10対応）、表スタイリング強化（ヘッダー色・交互行・列幅設定）、テンプレート検証機能。(2) テンプレートv4.docx新規作成 - 46個のプレースホルダー対応。(3) release_tab.py UI改善 - テンプレート選択UI、表追加オプション（4種類チェックボックス）、表示件数スライダー追加 |
| v7.11 | 2025-12-14 | **包括的検証完了**: 全215ランキングの自動テストを実施。URL到達率100%（215/215）、部門検出率76.3%（164/215）、エラー0件。カテゴリ分類調査：公式サイトとの差異は軽微（美容・ウエディング統合、生活関連分離）、B2Bランキング（5件）は意図的に除外。v7.10までの機能が全ランキングで正常動作することを確認 |
| v7.10 | 2025-12-12 | **部門名表示バグ修正（2件）**: (1) `parse_uploaded_excel()`: 部門シート判定条件に`部門`を追加、`部門_XXX`形式を認識。(2) `_extract_dept_name_from_title()`: パターン0.8の誤マッチ修正（「におすすめの」「のおすすめ」「に強い」「を希望」を除外）、派遣会社向けパターン追加（パターン2.5「XXXに強い」、2.55「XXXを希望」、2.6「XXXのおすすめ」）。表示名が「派遣会社」「おすすめ派遣会社」になる問題を修正 |
| v7.9 | 2025-12-12 | **SiteStructureAnalyzer統合+エラーハンドリング強化**: 1回のHTTPリクエストで評価項目・部門・過去年度を一括取得。`site_analyzer.py` (v1.1)を新規追加。`analyze_structure()`メソッドを追加。キャッシュ機能付き。**エラーハンドリング強化**: `StructureValidator`クラスによる構造妥当性検証、評価項目数/部門数/年度範囲の閾値チェック、`check_structure_change()`による前回比較検知機能 |
| v7.8 | 2025-12-12 | **sort-nav TABLE構造の複数リンク対応**: `_extract_departments_from_sort_nav()`で`td.find()`→`td.find_all()`に修正。派遣会社の業務内容別（type/logistics.html等）が正しく検出されるように。修正前: 6部門 → 修正後: 26部門を検出 |
| v7.7 | 2025-12-11 | **sort-nav TABLE構造対応**: `_extract_departments_from_sort_nav()`を実際のサイト構造（`<table>` + `<th>` + `<td>`）に対応。全215ランキング包括テストで確認（TABLE構造97.2%、SECTION構造0%）。旧SECTION構造はフォールバック。**新アーキテクチャ実装方針策定**: SiteStructureAnalyzer/DepartmentDetector Facade/Feature Flag/Cache Layerの4フェーズ計画 |
| v7.6 | 2025-12-11 | v7.5誤検出修正: evaluation-itemは「評価項目別」であり「部門別」ではないため、v7.5の変更を取り消し |
| v7.5 | 2025-12-11 | ⚠️**取り消し済み**: evaluation-itemを部門として検出する変更は誤りだったためv7.6で取り消し |
| v7.4 | 2025-12-11 | ハイブリッド強化方式（URL正規化 + パターン追加 + バリデーション層）: 英会話スクールlevel/class対応、代理店型agency対応、都道府県誤検出防止（INVALID_DEPT_NAMES追加）、URL正規化レイヤー追加、クエリパラメータ除外パターン強化 |
| v7.3.1 | 2025-12-09 | 社名正規化の網羅性向上（得点推移分析・初登場年計算への適用追加）、正規化前処理追加（全角/半角英数字変換、連続空白正規化）、コードレビューによるバグ修正 |
| v7.3 | 2025-12-09 | 引越し会社の部門別抽出対応（/family/, /prefecture/, /area/, /gender/パターン追加）、社名エイリアス機能（社名変更時の連続記録・受賞回数通算）、UI改善（歴代記録タブのグラフ位置変更、ランキング順位表のUnnamed列削除、総合/評価項目別/部門別タブのグラフ配置最適化） |
| v7.2 | 2025-12-03 | 推奨TOPICSタブの時点表示を調査概要の更新日から動的取得（取得日ベース→更新日ベースへ変更） |
| v7.1 | 2025-12-03 | 部門別ページタイトル抽出修正（_extract_page_title_for_dept使用で誤検出防止）、推奨TOPICSタブの時点表示に月を追加（2025年12月時点） |
| v7.0 | 2025-12-03 | ハイブリッド自動検出（sort-nav優先 + レガシーフォールバック）、同点1位獲得回数対応、サブパス部門検出修正 |
| v6.2 | 2025-12-02 | コードレビュー・リファクタリング（SVODジャンル別部門名抽出修正、genre/パターン追加、全ランキング部門抽出テスト確認） |
| v6.1 | 2025-12-02 | 連続記録計算を発表回数ベースに修正（未発表年スキップ）、評価項目・部門タブのレイアウト変更（名称変更→1位推移→経年推移→年数/URL）、子ども英語教室の幼児/小学生部門検出追加 |
| v6.0 | 2025-12-02 | ネット証券部門対応（外国株式、投資信託、スマホ証券等）、評価項目・部門タブの上部にトレンドグラフを配置 |
| v5.9 | 2025-12-01 | UI改善（総合ランキングURLクリック可能化、連続1位記録2年以上フィルタ、推奨TOPICS3カテゴリ分類表示、1位獲得回数ランキング獲得率削除） |
| v5.8 | 2025-12-01 | 推奨TOPICS拡充（評価項目別・部門別の連続1位記録、部門独占状況、得点差分析を追加） |
| v5.7 | 2025-12-01 | 全215ランキング包括的テスト・修正（医療保険URL修正、バイク販売店/電子コミック/映画館/テーマパーク部門検出追加、Critical問題修正） |
| v5.6 | 2025-12-01 | FX部門別ランキング検出修正（style追加、タイトル抽出パターン追加で初心者/スキャルピング等9部門を検出可能に） |
| v5.5 | 2025-11-28 | 棒グラフ改善（mark_rectによる非0基点実装で差分が見やすく、サイズ拡大: height 200→350, width 80→100）、顧客満足度/FP評価の分離対応（#1/#2ハッシュによるURL区別）、警告文言簡素化 |
| v5.4 | 2025-11-28 | 名称変更検出改善（ページタイトルから実際の評価項目名・部門名を取得、最新名称をexpanderタイトルに表示） |
| v5.3 | 2025-11-28 | アップロード機能の隠し化（環境変数 ENABLE_UPLOAD_FEATURE で制御、Cloud環境ではデフォルト非表示） |
| v5.2 | 2025-11-28 | グラフ機能拡張（折れ線グラフをTOP10全企業の経年推移に変更、縦棒グラフの縦軸を動的に設計：データ範囲に応じてmin-2〜max+2で自動調整） |
| v5.1 | 2025-11-28 | 名称変更検出機能（評価項目・部門の名称が途中で変更された場合「●●年から〜に変更」と注記表示） |
| v5.0 | 2025-11-28 | グラフ機能強化（総合得点の年表記横にURL配置、各年度の表の下に縦棒グラフ追加、経年変化の折れ線グラフを「1位の推移」の下に配置） |
| v4.9 | 2025-11-28 | 総合ランキングタブに1位獲得回数ランキングを追加（評価項目別・部門別と同様のロジック） |
| v4.8 | 2025-11-28 | 透明性向上: サイドバー左下に更新履歴を折りたたみ表示（HANDOVER.mdから動的読み込み） |
| v4.7 | 2025-11-28 | 8件の改善要望対応（連続記録ロジック修正、1位獲得回数ランキング改善、URL表示位置変更、参考資料タブURL有効化、連続1位記録表示条件変更、推奨TOPICS根拠削除、ツール上部記載変更、UIレイアウト変更） |
| v4.6 | 2025-11-27 | 1位獲得回数表示拡充（評価項目別・部門別タブに1位獲得回数ランキングを追加、年度検出ロジック修正：更新日を年度基準として使用） |
| v4.5 | 2025-11-27 | Multi-AIレビュー対応（25件の漏れランキング追加、Critical/Highバグ修正、コードリファクタリング） |
| v4.4 | 2025-11-27 | 同率順位対応（同点の場合「同率1位」として分析、2社/3社以上にも対応） |
| v4.3 | 2025-11-27 | 動的年度検出（トップページから実際の発表年度を自動判定、未発表年度スキップ） |
| v4.2 | 2025-11-27 | コードレビュー対応（セキュリティ改善、リトライ処理追加、動的年度範囲） |
| v4.1 | 2025-11-27 | 過去年度URL修正（/subpath/year/形式優先）、Altair faceted chartでグラフ表示 |
| v4.0 | 2025-11-27 | グラフ表示修正（評価項目別/部門別グラフがtrendsの有無に関わらず表示） |
| v3.9 | 2025-11-27 | バグ修正（0値判定、連続年数計算、グラフスコア、URL表示改善） |
| v3.8 | 2025-11-27 | UI改善（URL全文表示、タブ統合、評価項目別/部門別グラフ追加） |
| v3.7 | 2025-11-26 | 順位抽出ロジック修正（icon-rank優先、評価項目別テーブル除外） |
| v3.6 | 2025-11-25 | Excel抽出改善、URLリンク化、グラフ軸変更 |
| v3.5 | 2025-11-25 | 年度列誤検出防止、年度妥当性チェック |
| v3.4 | 2025-11-25 | Webサイト最新年度制限、デバッグログ追加 |
| v3.2 | 2025-11-25 | ファイルアップロード機能強化 |

## ファイル構成

```
streamlit-app/
├── app.py              # メインアプリケーション
├── scraper.py          # Webスクレイピングロジック
├── analyzer.py         # TOPICS分析・歴代記録分析
├── site_analyzer.py    # サイト構造解析モジュール（v7.9追加）
├── company_master.py   # 企業名マスタ・正規化
├── validator.py        # プレスリリース正誤チェック
├── release_generator.py # プレスリリース本体生成（テンプレート+ルールベース）
├── release_tab.py      # プレスリリース作成UI（v1.2: ワンクリック生成対応）
├── word_generator.py   # Word文書出力（v3.0: 複数表・スタイリング対応）
├── image_generator.py  # ランキング表画像化
├── requirements.txt    # 依存パッケージ
├── config/
│   └── company_aliases.json  # 社名エイリアス定義
├── docs/
│   └── HANDOVER.md     # 本引継ぎ資料
├── _archive/
│   └── テンプレート/   # Wordテンプレート（v3/v4）
└── test/               # テストデータ
```

## 主要機能

### 1. Webスクレイピング (scraper.py)
- オリコン顧客満足度ランキングサイトからデータを取得
- URL構造:
  - 最新年度: `https://life.oricon.co.jp/rank-{slug}/`
  - 過去年度: `https://life.oricon.co.jp/rank-{slug}/{year}/`
- 対応ランキング: FX、携帯キャリア、格安SIM、証券、保険など

### 2. Excelファイル解析 (app.py: parse_uploaded_excel)

#### 対応フォーマット
オリコン内部Excelファイルの構造に対応:

```
Row 0: FX
Row 1: シート名（業態別、評価項目など）
Row 2: カテゴリ名（FX専業、スキャルピングトレードなど）
Row 3: n＝ 100（サンプルサイズ）
Row 4: 順位, ID, ランキング対象企業名, 回答者数, ...（ヘッダー）
Row 5〜: データ行
```

#### シート種別と処理

| シート種別 | 判定条件 | 抽出先 |
|-----------|---------|--------|
| 総合対象企業 | '総合' or '対象企業' in シート名 | overall_data |
| 評価項目 | '評価項目' in シート名 + 1列目が項目名 | item_data |
| 部門別 | '別' で終わるシート名 | dept_data |

#### 重要な修正点 (v3.5-3.7)

**問題1: 年度列の誤検出 (v3.5)**
- 原因: `回答者数（最新年）`列が「年」を含むため年度列として誤検出
- 修正: 除外パターンを追加 (`回答者数`, `最新年`, `前年` 等)
- 対策: 年度値が2000-2030の範囲外なら指定年度を使用

**問題2: 部門名の誤検出 (v3.6)**
- 原因: カテゴリ名検出が「n＝ 100」を拾っていた
- 修正: Row2を優先的に確認、`n＝`を含む行を除外

**問題3: 順位の誤取得 (v3.7)**
- 原因: 評価項目別テーブル内の `<img alt="2位">` を総合順位として誤取得
- 症状: Netflix(77点)が本来1位なのにDMM TV(75.3点)が1位と判定される
- 修正箇所: `scraper.py` の `_extract_ranking_data` メソッド
- 修正内容:
  1. `icon-rank` クラスを最優先で探索（総合順位の正しい表示場所）
  2. `td.rank` 内（評価項目別テーブル）の img を除外
  3. `ranking-score` セクション内の順位を除外
  4. 順位の範囲検証（1-100）を追加

**問題4: v3.8 UI改善 (2025-11-27)**
- 変更内容:
  1. URL表示を「リンクを開く」ボタンから全文URL表示に変更
  2. 見出し案タブを推奨TOPICSタブに統合（タブ数削減）
  3. 歴代記録タブに評価項目別/部門別の平均得点推移グラフを追加
  4. インパクト/最重要ラベルを推奨TOPICSから削除
  5. DataFrameから空白列や数字のみの列名を除外

**問題5: v3.9 バグ修正 (2025-11-27 - Codexレビュー指摘)**
- 修正箇所と内容:

  **app.py:**
  1. **0点/0位が空文字になるバグ** (77-78行目)
     - 原因: `score if score else ""` が0をfalsyとして扱う
     - 修正: `score if score is not None else ""`

  2. **ヘッダー検出条件の緩和** (235-241行目)
     - 原因: ID列必須条件が厳しすぎてシートをスキップ
     - 修正: 「順位」+「企業/ランキング/会社」で検出

  3. **セッション状態リセット** (902-903行目)
     - 原因: エラー後も前回結果が表示される
     - 修正: 実行開始時に `st.session_state.results_data = None`

  4. **グラフスコアフィルタリング** (1321, 1354行目)
     - 原因: `d.get("score")` が0を除外
     - 修正: `d.get("score") is not None`

  5. **評価項目別/部門別タブURL表示** (1466-1472, 1527-1533行目)
     - 変更: 各年度データの下に該当年度のURLを表示
     - URL名形式: `{項目名}({year}年)` でマッチング

  **analyzer.py:**
  1. **連続年数計算で年度欠落を考慮** (_calc_consecutive_wins)
     - 原因: 2022→2024と飛んでも連続とカウント
     - 修正: `prev_year` を追跡し `year == prev_year + 1` をチェック

  2. **スコア差分分析のNoneチェック** (504-508行目)
     - 原因: `if not score1` が0を除外
     - 修正: `if score1 is None or score2 is None`

  3. **評価項目支配率の母数計算** (530-578行目)
     - 原因: 空データを含む全項目数を母数に使用
     - 修正: `actual_items` で実データ数のみカウント

  4. **項目特徴分析のスコアチェック** (602-606行目)
     - 修正: `if score1 is not None and score2 is not None`

**問題6: 評価項目別/部門別 平均得点推移グラフが表示されない (v4.0で解決)**
- 症状: 歴代記録タブの「評価項目別 平均得点推移」「部門別 平均得点推移」グラフが表示されない
- **根本原因**: グラフ表示コード（1312-1376行目）が `if trends and trends.get("years"):` ブロック内にネストされていた
  - `trends`（総合ランキングの得点推移）が空の場合、評価項目別/部門別グラフも表示されなかった
- **修正内容** (v4.0):
  - 評価項目別/部門別グラフを `if trends` ブロックの外に移動
  - `import altair as alt` をグラフ描画直前に追加（スコープ対応）
  - エラーメッセージを改善（「データにスコアが含まれていません」を追加）

**問題7: 過去年度データが取得できない - サブパスありランキング (v4.1で解決)**
- 症状: 24時間ジム（_fitness/24hours）等で2025年のみ取得され、過去年度が取得できない
- **根本原因**: URL構造の誤り
  - 誤: `/rank_fitness/2024/24hours/`
  - 正: `/rank_fitness/24hours/2024/`
- **修正内容** (v4.1):
  - scraper.py: `/subpath/year/` 形式を優先、失敗時に `/year/subpath/` 形式をフォールバック
  - 部門別・評価項目別URLも同様に修正

**問題8: グラフが積み上げ縦棒になる (v4.1で解決)**
- 症状: 年度別比較グラフが積み上げ式で表示され、比較しづらい
- **修正内容** (v4.1):
  - Altair faceted chart (`column=alt.Column()`) を使用
  - 各評価項目/部門ごとに年度別棒グラフを横並びで表示

**問題9: セキュリティとネットワーク安定性 (v4.2で解決 - Geminiレビュー対応)**
- 修正箇所と内容:

  **app.py:**
  1. **トレースバック情報漏洩** (433-438行目)
     - 問題: エラー時にスタックトレースがユーザーに表示される
     - 修正: ログにのみ出力、ユーザーには一般的なエラーメッセージのみ表示

  2. **年度範囲のハードコード** (357-361行目)
     - 問題: `year > 2030` が将来機能しなくなる
     - 修正: `datetime.now().year + 5` で動的に計算

  3. **ロギング追加** (12-16行目)
     - 変更: logging設定を追加し、デバッグ情報をログに出力

  **scraper.py:**
  1. **リトライ処理追加** (155-171行目)
     - 問題: ネットワークエラー時に即座に失敗
     - 修正: `urllib3.util.retry.Retry` で500系エラー時に最大3回リトライ（バックオフ付き）

**問題10: 最新年度が未発表の場合に過去年度が取得できない (v4.3で解決)**
- 症状: 携帯キャリアで「2025年 ✅」「2024年 ❌」のように2024年が失敗扱いになる
- **根本原因**: `year == end_year` でトップページURLを使用していたが、実際のトップページは2024年のデータ
  - 2025年を要求 → トップページURL使用 → 実際には2024年データを取得
  - 2024年を要求 → /2024/ URL使用 → 存在しない（404）
- **修正内容** (v4.3):
  - `_detect_actual_year()` メソッド追加: トップページから実際の発表年度を検出
    - パターン1 (最優先): 最終更新日 `最終更新日：2025-11-01` から年度検出
    - パターン2: タイトル `2025年 オリコン顧客満足度` から年度検出
    - パターン3: ページ冒頭30行内の年度表記 `2025年 ネット証券` から年度検出
    - パターン4: 調査期間 `2024/05/24～2024/07/23` から年度検出
    - パターン5 (フォールバック): 過去リンク最大値 + 1 で推定（信頼性低）
  - 未発表年度（`year > actual_top_year`）は自動スキップ
  - トップページの年度と一致する年度のみ年度なしURLを使用
  - 検出した年度はキャッシュして再利用

  **v4.3.1 改善点（ネット証券対応）**:
  - 問題: ネット証券(rank_certificate)で2025年なのに2023年と誤検出
    - 原因: 過去リンクパターン(/2022/)から 2022+1=2023 と推定（年度が飛んでいる場合に不正確）
  - 解決: 最終更新日パターンを最優先に変更
    - `最終更新日：2025-11-01` → 正しく2025年を検出

  **テスト結果（携帯キャリア 2023-2025）**:
  ```
  2025  SKIP  -  (未発表)
  2024  OK    https://life.oricon.co.jp/rank-mobile-carrier/
  2023  OK    https://life.oricon.co.jp/rank-mobile-carrier/2023/
  ```

  **テスト結果（ネット証券 2023-2025）**:
  ```
  2025  OK    https://life.oricon.co.jp/rank_certificate/  (最終更新日から検出)
  2024  OK    https://life.oricon.co.jp/rank_certificate/2024/
  2023  OK    https://life.oricon.co.jp/rank_certificate/2023/
  ```

### 3. データ統合

```python
# アップロードデータが優先
merged = merge_data(uploaded_overall, scraped_overall)
```

- アップロード年度はスクレイピング対象から除外
- Webサイトの最新年度(2025)を超える年度はスクレイピングしない

### 4. 分析機能 (analyzer.py)

- **歴代記録分析**: 連続1位、過去最高得点、最多1位獲得
- **得点推移分析**: 年度別平均、企業別推移
- **TOPICS生成**: 重要トピックスの自動抽出、見出し案生成

**問題11: 同点の場合の分析が不適切 (v4.4で解決)**
- 症状: SBI証券(68.9点) vs 楽天証券(68.9点)の場合、「得点差わずか0.0点の僅差」と表示
- 問題: オリコンでは同点は「同率1位」として扱う（2位は存在しない）
- **修正内容** (v4.4):
  - `_analyze_score_difference()` メソッドを改善
  - 同点の企業をすべて検出し、「同率1位」として分析
  - impact値を5に設定（通常の得点差分析より重要度が高い）

  **対応パターン**:
  | ケース | 入力例 | 出力 |
  |--------|--------|------|
  | 2社同率1位 | SBI証券=楽天証券(68.9点) | 「SBI証券と楽天証券が同率1位」 |
  | 3社以上同率1位 | A社=B社=C社(70.0点) | 「3社が同率1位で並ぶ」 |
  | 僅差（0.5点以下） | 68.9点 vs 68.5点 | 「1位と2位の得点差わずか0.4点の僅差」 |
  | 大差（2点以上） | 70.0点 vs 67.5点 | 「1位と2位の得点差2.5点、SBI証券が大きく引き離す」 |

  **実装詳細** (`analyzer.py:508-533`):
  ```python
  # 同率1位のチェック: 同じ得点の企業をすべて収集
  tied_companies = [first["company"]]
  for entry in data[1:]:
      if entry.get("score") == score1:
          tied_companies.append(entry["company"])
      else:
          break  # 得点が異なる企業が出たらループ終了

  # 同率1位が2社以上の場合
  if len(tied_companies) >= 2:
      if len(tied_companies) == 2:
          return {
              "importance": "重要",
              "title": f"{tied_companies[0]}と{tied_companies[1]}が同率1位",
              "evidence": f"両社とも{score1}点で並ぶ",
              "impact": 5
          }
  ```

## UI機能

### 参考資料URL
- `st.column_config.LinkColumn`でクリック可能なリンクを表示
- 「🔗 リンクを開く」ボタンで直接ページを開ける

### グラフ
- **棒グラフ (v5.5)**: `mark_rect`による非0基点実装
  - Altairの`mark_bar`は設計上、常に0を基点として描画される仕様
  - `domain=[min, max]`や`zero=False`では棒の基点は変わらない（仕様）
  - 解決策: `mark_rect`で`y`(基点)と`y2`(得点)を明示指定
  - 得点範囲: 最小値-5 〜 最大値+2（差分を見やすく）
  - サイズ: height=350/400, width=100（従来比1.5-2倍）
- **折れ線グラフ**: TOP10企業の経年推移を表示
- Altairを使用したインタラクティブなグラフ

## 使用方法

### 起動
```bash
cd streamlit-app
streamlit run app.py --server.port 8505
```

### 基本的な使い方
1. サイドバーでランキングを選択（例: FX（顧客満足度））
2. 過去データ取得範囲を選択
3. （オプション）最新のExcelファイルをアップロード
4. アップロードデータの年度を指定（例: 2026）
5. 「TOPICS出し実行」をクリック

### Excelファイルの要件
- 形式: .xlsx
- ヘッダー行に「順位」「ID」「ランキング対象企業名」を含むこと
- 得点は「スコア」「合計」「得点」列から取得

## トラブルシューティング

### 年度が異常な値になる
- 原因: 年度列の誤検出
- 対処: サイドバーで「アップロードデータの年度」を明示的に指定

### 部門名が「n＝ 100」になる
- v3.6で修正済み
- カテゴリ名がRow2から正しく取得されるようになった

### スクレイピングが失敗する
- ネットワーク接続を確認
- オリコンサイトの構造変更の可能性を確認
- `scraper.py`のセレクタを確認

**問題12: Multi-AIレビューによる大規模リファクタリング (v4.5で解決)**
- 実施: Perplexity（全ランキング調査）+ Gemini（コードレビュー×3ファイル）による包括的レビュー
- **発見された問題と修正**:

  **Critical修正:**
  1. **st.exception()のセキュリティリスク** (app.py:1101)
     - 問題: スタックトレースがユーザーに漏洩
     - 修正: `logger.error()`に変更、ユーザーには汎用エラーメッセージのみ表示

  2. **ゼロ除算エラー** (app.py:118)
     - 問題: `total_years=0`の場合に`ZeroDivisionError`
     - 修正: `if r['total_years'] > 0 else "0.0%"` の条件追加

  3. **年度検出ロジック簡素化** (scraper.py:202-270)
     - 問題: 調査期間パターンが不要（更新日が正式な年度基準）
     - 修正: 調査期間パターン削除、更新日優先のシンプルなロジックに

  **High修正:**
  1. **current_yearハードコード** (app.py:888)
     - 問題: `current_year = 2025` が将来機能しなくなる
     - 修正: `datetime.now().year` で動的取得

  2. **カテゴリフィルタ不足** (app.py:838)
     - 問題: 「外貨預金」「キャッシュレス決済」がフィルタにヒットしない
     - 修正: 金融カテゴリに「外貨」「決済」キーワード追加

  3. **_actual_top_year未初期化問題** (scraper.py)
     - 問題: `get_evaluation_items`/`get_departments`を単独呼び出し時にフォールバック値(2024)使用
     - 修正: `_ensure_actual_top_year()` ヘルパーメソッド追加、各メソッドで確実に初期化

  **追加された新ランキング（25件）:**
  - キャリア格安ブランド (`mobile-carrier/reasonable`)
  - プロバイダ地域別（9件）: 北海道、東北、北関東、首都圏、甲信越・北陸、東海、近畿、中国・四国、九州・沖縄
  - 動画配信ジャンル別（11件）: 国内ドラマ、海外ドラマ、韓国ドラマ、邦画、洋画、韓国映画、アニメ、キッズ・ファミリー、音楽、バラエティ、スポーツ
  - ウォーターサーバー（浄水型）、住宅ローン（FP評価）、パーソナルトレーニング、光回線10ギガ

  **年度検出の優先順位（v4.5）:**
  1. 最終更新日（最も信頼性が高い）← 例: `2024/12/02` → 2024年
  2. タイトルの年度表記
  3. ページ冒頭の年度表記
  4. 過去リンクからの推定（フォールバック）

  ※調査期間は使用しない（更新日が正式な年度基準のため）

**問題13: FX部門別ランキングが検出されない (v5.6で解決)**
- 症状: FXランキングで部門別（初心者、スキャルピングトレード等）が0件と表示される
- **根本原因**: 2つの問題があった

  1. **`dept_patterns`に`style`が含まれていなかった** (scraper.py:573)
     - FXには「取引スタイル別」（style/）のカテゴリがあるが、パターンに含まれていなかった
     - 修正: `style` をパターンに追加
     ```python
     # 変更前
     dept_patterns = [
         r"/(age|genre|contract|new-contract|device|business|beginner|type|purpose|nisa|ideco)(?:/|\.html)",
     ]
     # 変更後
     dept_patterns = [
         r"/(age|genre|contract|new-contract|device|business|beginner|type|purpose|nisa|ideco|style)(?:/|\.html)",
     ]
     ```

  2. **`_extract_dept_name_from_title`のパターンが不足** (scraper.py:791-890)
     - FXページのタイトル形式「【2025年】FXの初心者ランキング・比較」に対応していなかった
     - 既存パターン: 「XXX向けの」「XXXにおすすめの」のみ
     - 修正: 新パターン追加
     ```python
     # パターン0.5: 【年度】XXXのYYYランキング → YYY を抽出（FX向け）
     # 例: 【2025年】FXの初心者ランキング・比較 → 初心者
     # 例: 【2025年】FXのスキャルピングトレードランキング・比較 → スキャルピングトレード
     match = re.search(r"】[^\s【】]+の(.+?)ランキング", text)
     if match:
         dept_name = match.group(1).strip()
         if dept_name and dept_name not in ["顧客満足度", "オリコン顧客満足度", "満足度"] and len(dept_name) <= 20:
             return dept_name
     ```

  **修正後の検出結果（9部門）**:
  - 初心者 (`beginner/`)
  - PC (`device/`)
  - スマホアプリ (`device/app.html`)
  - FX専業者 (`business/`)
  - 証券会社 (`business/securities.html`)
  - スキャルピングトレード (`style/`)
  - デイトレード (`style/day-trading.html`)
  - スイングトレード (`style/swing-trading.html`)
  - スワップトレード (`style/swap-trading.html`)

  **テスト結果**:
  - 部門URL成功: 18件（100%）
  - 評価項目URL成功: 18件
  - 総合ランキング: 2024年、2025年ともに取得成功

  **補足: 総合ランキングの年毎URLについて**
  - ユーザー報告: 「総合ランキングタブの年毎のURLが機能していない」
  - 調査結果: `https://life.oricon.co.jp/rank_fx/2024/` は正常にアクセス可能
  - 原因: トップページから過去年度へのリンクがないだけで、URLパターン自体は正しく動作していた
  - 結論: 実際には問題なし（年度別データは正常に取得できている）

**問題14: 全215ランキング包括的テスト・コード品質改善 (v5.7で解決)**
- 実施: Perplexity（サイト構造調査）+ Gemini（コードレビュー）+ Claude Opus 4.5（統合・最終判断・包括テスト実行）
- **テスト範囲**: **全215種類のランキング**（ranking_options定義全件）

  **修正内容一覧:**

  **1. Critical修正 (3件):**
  - **サイレントエラーハンドリング**: `try-except-pass` → `logger.warning()` でエラー記録
  - **危険なデフォルト評価項目**: 携帯キャリア項目の自動適用を削除
  - **汎用すぎるパターン0**: 短いテキスト → 既知の部門名ホワイトリスト方式

  **2. URL修正 (1件):**
  - **医療保険(medical_insurance)**: `rank-medical_insurance` → `medical_insurance`（rankプレフィックスなし）
  - `NO_RANK_PREFIX` リストを新設、URLパターン分岐を追加

  **3. 部門検出パターン追加 (5件):**
  - `sim|sp`: 格安SIM（mvno）
  - `specialty|manufacturer`: バイク販売店
  - `general|publisher|original`: 電子コミック/マンガアプリ
  - `hokkaido|tohoku|kanto|kinki|tokai|...`: 地域別（映画館、プロバイダ等）
  - `east|west`: テーマパーク

  **最終テスト結果 (v5.7)**:
  | ステータス | 件数 | 詳細 |
  |-----------|------|------|
  | OK | **215** | 全ランキングで部門または評価項目が正常検出 |
  | WARN | **0** | 問題なし |
  | Error | **0** | エラーなし |

  **検出統計**:
  | 検出パターン | 件数 |
  |-------------|------|
  | 部門+評価項目あり | 158件 |
  | 部門のみ | 6件 |
  | 評価項目のみ | 51件 |
  | どちらもなし | **0件** |

  **テストファイル**:
  - `test_all_rankings_comprehensive.py`: 全ランキング自動テストスクリプト
  - `test_report_comprehensive.json`: 詳細レポート（JSON形式）

**問題15: 推奨TOPICSの拡充 (v5.8で対応)**
- 要望: 総合ランキングだけでなく、評価項目別・部門別の連続記録や得点にもフォーカスしたい
- **拡張内容**:

  **1. TopicsAnalyzerの拡張:**
  - コンストラクタに `dept_data` 引数を追加（後方互換性維持）
  - 新規分析メソッド4件を追加

  **2. 追加された分析機能:**
  | メソッド名 | 分析内容 | 対象 |
  |-----------|---------|------|
  | `_analyze_item_consecutive_wins()` | 評価項目別の連続1位記録 | 3年以上連続 |
  | `_analyze_dept_consecutive_wins()` | 部門別の連続1位記録 | 3年以上連続 |
  | `_analyze_dept_dominance()` | 部門別の独占状況 | 60%以上 or 3部門以上 |
  | `_analyze_dept_features()` | 部門別の得点差分析 | 2位と3点差以上 |

  **3. TOPICS出力例（テストデータ）:**
  ```
  1. [総合] A社が3年連続で総合1位を達成 (impact: 5)
  2. [総合] 1位と2位の得点差3.0点、A社が大きく引き離す (impact: 4)
  3. [総合] A社が2項目中2項目で1位を独占 (impact: 4)
  4. [評価項目別] 『料金プラン』でA社が3年連続1位 (impact: 3)
  5. [部門別] 『30代』部門でA社が3年連続1位 (impact: 3)
  6. [部門別] 『40代』部門でB社が3年連続1位 (impact: 3)
  ```

  **4. impactスコア設計:**
  | 種別 | impact | 条件 |
  |------|--------|------|
  | 総合連続1位 | 5 | 2年以上連続 |
  | 総合得点差（大差） | 4 | 2点以上 |
  | 評価項目/部門独占 | 4 | 60%以上 |
  | 評価項目連続1位 | 3-4 | 3年で3, 5年以上で4 |
  | 部門連続1位 | 3-4 | 3年で3, 5年以上で4 |
  | 部門1位複数獲得 | 3 | 3部門以上 |

  **5. 修正ファイル:**
  - `analyzer.py`: TopicsAnalyzerクラスを拡張（4メソッド追加）
  - `app.py`: TopicsAnalyzer呼び出し時に`dept_data`を渡すよう修正

## 今後の改善案

1. **複数年度Excelの対応**: 1ファイルで複数年度のデータを持つ形式
2. **キャッシュ機能**: スクレイピング結果のローカルキャッシュ
3. **比較機能**: 複数ランキング間の比較分析
4. **テンプレート出力**: プレスリリース用テキストの自動生成
5. **テスト追加**: 0値/None値を含むデータでの単体テスト
6. **型アノテーション**: Optional型の明示化（score: Optional[float]）

## 依存関係

```
streamlit>=1.28.0
pandas>=2.0.0
requests>=2.31.0
beautifulsoup4>=4.12.0
openpyxl>=3.1.0
xlsxwriter>=3.1.0
altair (streamlitに含まれる)
```

## 連絡先

本システムに関する質問は開発担当者まで。

---

## 次回セッション向け改善要望（2025-11-27登録） → **v4.7で全件解決済み**

以下の8件の改善要望は、v4.7（2025-11-28）で全て対応完了しました。

### ✅ 1. 連続記録ロジックの修正【重要】
- **問題**: 携帯キャリアでdocomoが「9年連続通信速度1位（2015〜2023）」と表示されるが、実際は2016〜2021年は発表されていない
- **修正内容**: 連続記録は「発表回数」を基準にする（未発表年度をスキップして連続とカウント）
- **対象ファイル**: `analyzer.py` の `_calc_consecutive_wins` メソッド
- **対応日**: 2025-11-28

### ✅ 2. 1位獲得回数ランキングの改善
- **並び替え**: 評価項目別・部門別の1位獲得回数ランキングを、1位回数の多い順にソート
- **継続中表示**: 獲得回数ランキング内に「継続中」フラグ（最新年度も1位なら✅表示）を追加
- **対象ファイル**: `app.py` タブ4, タブ5の表示部分
- **対応日**: 2025-11-28

### ✅ 3. URL表示位置の変更
- **変更内容**: 年度の横にURL表示
  ```
  2024年 🔗 https://...
  ランキング表
  ```
- **対象ファイル**: `app.py` タブ4, タブ5のURL表示部分
- **対応日**: 2025-11-28

### ✅ 4. 参考資料タブのURL有効化
- **修正内容**: `st.column_config.LinkColumn` を使用してクリック可能なリンクに変更
- **対象ファイル**: `app.py` タブ6
- **対応日**: 2025-11-28

### ✅ 5. 連続1位記録の表示条件変更
- **条件変更**: 複数回1位を獲得したもののみ対象（1年だけの受賞は除外）
- **件数拡充**: 上位5件 → 上位10件に拡充
- **対象ファイル**: `app.py` タブ2, タブ4, タブ5の連続1位記録セクション、`display_consecutive_wins_compact` 関数
- **対応日**: 2025-11-28

### ✅ 6. 推奨TOPICSの根拠削除
- **修正内容**: 推奨TOPICSセクションから根拠説明（`- **根拠**: ...`）を削除
- **対象ファイル**: `app.py` タブ1
- **対応日**: 2025-11-28

### ✅ 7. ツール上部の記載変更
- **変更後**:
  ```
  📰 オリコン顧客満足度®調査 TOPICSサポートシステム
  オリコン顧客満足度調査の経年結果を調査。連続記録や1位獲得回数の参照に活用いただけます。
  ⚠️ 注意事項: 情報の正確性は担当者が必ず確認してください。未公開情報を含んだエクセル等はアップロードしないでください。
  ```
- **対象ファイル**: `app.py` 行545-547付近
- **対応日**: 2025-11-28

### ✅ 8. UIレイアウト変更
- **Excelアップロード**: `st.sidebar.expander` で折りたたみ式に変更（非推奨機能のため）
- **実行ボタン移動**: 「TOPICS出し実行」ボタンを「過去データ取得範囲」の直下に移動
- **対象ファイル**: `app.py` サイドバー部分
- **対応日**: 2025-11-28

---

## v6.2 コードレビュー・リファクタリング (2025-12-02)

### 背景
v6.1までの実装に対して包括的なコードレビュー・デバッグ・リファクタリングを実施。
全ランキングの部門抽出が正しく動作することを確認。

### 修正内容

#### 1. SVODジャンル別部門名抽出修正 (scraper.py:830-838)

**問題**: SVODランキングで「アニメ」「洋画」等のジャンル名が正しく抽出されず、すべて「ジャンル別満足度」と表示されていた。

**原因**: ページタイトルが「【アニメ】動画配信サービスのジャンル別ランキング」形式だが、`_extract_dept_name_from_title`関数がこのパターンに対応していなかった。

**修正**: 新しいパターンを最優先で追加
```python
# パターン-1（最優先）: 【ジャンル名】XXXサービスの... → ジャンル名 (SVOD向け)
# 例: 【アニメ】動画配信サービスのジャンル別ランキング → アニメ
# 例: 【洋画】動画配信サービスのジャンル別ランキング → 洋画
match = re.search(r"【([^年】]+?)】(?:動画配信|定額制)", text)
if match:
    dept_name = match.group(1).strip()
    # 年度（2025年など）でない場合のみ
    if dept_name and not re.match(r"^\d{4}年?$", dept_name) and dept_name not in ["最新"]:
        return dept_name
```

#### 2. genre/パターン追加 (scraper.py:594)

**問題**: SVODの`genre/`パターンが`dept_patterns`に含まれていなかった。

**修正**: パターンに追加
```python
dept_patterns = [
    # ... 既存パターン ...
    r"/(genre)(?:/|\.html)",  # SVOD: ジャンル別
]
```

### テスト結果

| ランキング | 部門数 | 結果 |
|-----------|--------|------|
| 子ども英語教室（幼児） | 2部門 | ✅ 幼児、小学生 |
| 子ども英語教室（小学生） | 2部門 | ✅ 幼児、小学生 |
| ネット証券 | 13部門 | ✅ 初心者、NISA、外国株式、投資信託等 |
| FX | 10部門 | ✅ 初心者、PC、スマホアプリ、各トレードスタイル |
| SVOD | 13部門 | ✅ アニメ、洋画、韓国ドラマ等（**修正後**）|
| テーマパーク | 2部門 | ✅ 東日本、西日本 |

### 連続記録計算ロジック確認

v6.1で実装した「発表回数ベース」の連続記録計算が正しく動作することを確認。

**テストケース**: 2016〜2025年で2018年は未発表
- **期待値**: 9年連続（2016, 2017, 2019, 2020, 2021, 2022, 2023, 2024, 2025）
- **結果**: ✅ 正しく9年連続と計算

```python
# テスト結果
Company: CompanyA
Years: 9
Period: 2016~2025
Years List: [2016, 2017, 2019, 2020, 2021, 2022, 2023, 2024, 2025]
Is Current: True
```

### 今後の注意点

1. **新しいランキング追加時**: `dept_patterns`に必要なURLパターンが含まれているか確認
2. **タイトル形式変更時**: `_extract_dept_name_from_title`のパターンが対応しているか確認
3. **連続記録の表示**: `years_list`を使用して実際の年度を確認可能

---

## v7.2 推奨TOPICS時点表示を更新日から動的取得 (2025-12-03)

### 背景

v7.1で推奨TOPICSタブに月表示を追加したが、`datetime.now().month`（取得日）を使用していたため、
ランキングページの「調査概要」に記載されている更新日（例: 2025/01/06）と一致しない問題があった。

### 実装内容

1. **scraper.py: `get_update_date()` メソッド追加**
   - トップページから調査概要の更新日（年月）を動的に取得
   - キャッシュ機構でパフォーマンス向上
   - 更新日パターン: `(?:最終)?更新日[：:\s]*(\d{4})[-/](\d{1,2})[-/]\d{1,2}`

2. **app.py: 推奨TOPICSタブの時点表示を変更**
   - `datetime.now().month` → `update_date` から取得
   - 取得できない場合は現在日時にフォールバック

### コード例

```python
# scraper.py
def get_update_date(self) -> Optional[tuple]:
    """トップページから更新日（年, 月）を取得"""
    update_match = re.search(
        r'(?:最終)?更新日[：:\s]*(\d{4})[-/](\d{1,2})[-/]\d{1,2}', text)
    if update_match:
        return (int(update_match.group(1)), int(update_match.group(2)))
    return None

# app.py
if update_date:
    update_year, update_month = update_date
else:
    update_year = latest_year if latest_year else datetime.now().year
    update_month = datetime.now().month
```

### テスト結果

```
ネット証券: update_date = (2025, 12)  # 正常取得
結婚式場: update_date = None          # フォールバック動作
```

---

## v7.1 部門タイトル抽出修正 (2025-12-03)

### 問題

ネット証券の部門別ページで「ネット証券 オリコン顧客満足度」という存在しない部門が検出されていた。
原因は `get_departments()` で `_extract_page_title()` を使用しており、
評価項目用の抽出ロジック（`_extract_item_name_from_title()`）が適用されていたため。

### 修正内容

1. **scraper.py: `get_departments()` で正しい関数を使用**
   - `_extract_page_title()` → `_extract_page_title_for_dept()` に変更
   - 部門用の抽出ロジック（`_extract_dept_name_from_title()`）が適用されるように

2. **scraper.py: `_extract_dept_name_from_title()` に新パターン追加**
   - パターン0.6: `】([^\s【】]+?)に関する満足度の高い` (例: デイトレード)
   - パターン0.7: `】([^\s【】]+?)の運用におすすめの` (例: 外国株式)
   - パターン0.8: 「満足度」を含む誤マッチを除外

### テスト結果

```
【2025年】デイトレードに関する満足度の高いネット証券 → デイトレード ✅
【2025年】外国株式の運用におすすめのネット証券 → 外国株式 ✅
【2025年】スマートフォン・スマホサイトに関する満足度の高いネット証券 → スマートフォン・スマホサイト ✅
【2025年】国内株式の運用におすすめのネット証券 → 国内株式 ✅
```

---

## v7.0 ハイブリッド自動検出 (2025-12-03)

### 背景

v6.2までは部門検出にハードコードされた`dept_patterns`（URLパターン）を使用していた。
新しいランキングが追加されるたびにパターンを追加する必要があり、保守性に課題があった。

全194ランキングを調査した結果：
- **約63%** のページに `sort-nav` クラスが存在
- **約37%** のページには `sort-nav` がない（レガシーパターンが必要）

### 実装方針：ハイブリッドアプローチ

1. **sort-nav 優先**: ページに `sort-nav` クラスがあれば、h3見出しから部門を自動検出
2. **レガシーフォールバック**: `sort-nav` がない場合は従来の `dept_patterns` を使用

### sort-nav 構造（オリコンサイト共通）

⚠️ **v7.6で判明**: 以下の構造は実際のサイトと異なることが判明。
実際のサイトは `<table>` 構造を使用しており、`<section>` タグは存在しない。
そのため、現在の `_extract_departments_from_sort_nav()` は常に空を返し、
レガシーパターンにフォールバックしている。

**HANDOVERに記載されていた構造（実際には存在しない）:**
```html
<nav class="sort-nav">
  <section>
    <h3>評価項目別</h3>
    <ul>
      <li><a href=".../evaluation-item/...">項目名</a></li>
    </ul>
  </section>
</nav>
```

**実際のサイト構造（v7.6で発見）:**
```html
<div class="sort-nav sub-content">
  <h2>項目別ランキング一覧</h2>
  <p>説明文</p>
  <table>
    <tr>
      <th>TOP</th>
      <td>総合満足度ランキング</td>
    </tr>
    <tr>
      <th>評価項目別ランキング</th>
      <td>
        <a href="/evaluation-item/procedure.html">加入手続き</a>
        <a href="/evaluation-item/plan.html">商品内容</a>
      </td>
    </tr>
    <tr>
      <th>性別別ランキング</th>
      <td>
        <a href="/gender/">男性</a>
        <a href="/gender/woman.html">女性</a>
      </td>
    </tr>
    <tr>
      <th>年代別ランキング</th>
      <td>
        <a href="/age/">10・20代</a>
        <a href="/age/30s.html">30代</a>
      </td>
    </tr>
  </table>
</div>
```

**現状の動作:**
1. sort-navは見つかる（`<div class="sort-nav">`が存在）
2. `<section>`タグを探すが見つからない → 空のDictを返す
3. レガシーパターン（DEPT_PATTERNS）にフォールバック
4. レガシーパターンで部門を検出（現在機能している）

### 除外ルール

以下のh3見出しは部門として扱わない：
- 「評価項目別」「評価項目」（評価項目用のリンク）
- 「過去のランキング」「過去ランキング」（年度リンク）
- 「関連ランキング」（他カテゴリへのリンク）

### 同点1位獲得回数対応（v4.5由来）

`analyzer.py` の以下のメソッドで同点1位を正しくカウント：
- `_calc_most_wins()`: 総合ランキング
- `calc_item_most_wins()`: 評価項目別
- `calc_dept_most_wins()`: 部門別

修正ロジック：
```python
# 1位の得点を取得
top_score = data[0].get("score")

# 同点1位の企業をすべてカウント
for entry in data:
    if entry.get("score") == top_score:
        win_counts[company]["count"] += 1
    else:
        break  # 得点が異なったらループ終了
```

### サブパス部門検出修正（v4.4由来）

`scraper.py` の `_discover_departments()` でサブパスを考慮：
- 例：`rank-kids-english/grade-schooler/grade/` からの低学年・高学年検出
- `grade/` パターンを `dept_patterns` に追加
- `KNOWN_SIMPLE_DEPT_NAMES` に「低学年」「高学年」を追加

### 実装ファイル

- `scraper.py`: `_discover_departments()` にsort-nav検出ロジックを追加
- `analyzer.py`: 同点1位カウントロジック（既存）
- `HANDOVER.md`: 本ドキュメント

### 実装詳細（完了）

#### 1. `_discover_departments()` メソッドの修正 (scraper.py:566-681)

**ハイブリッドアプローチの実装:**

```python
def _discover_departments(self, url: str) -> Dict[str, str]:
    # Phase 1: sort-nav からの自動検出（優先）
    sort_nav = soup.find(class_="sort-nav")
    if sort_nav:
        departments = self._extract_departments_from_sort_nav(sort_nav, url)
        if departments:
            logger.info(f"sort-nav から {len(departments)} 件の部門を検出")
            return departments
        # sort-nav はあるが部門が見つからない場合はレガシーにフォールバック

    # Phase 2: レガシー dept_patterns による検出
    # (既存のロジック)
```

#### 2. `_extract_departments_from_sort_nav()` メソッドの新規追加 (scraper.py:683-760)

**sort-nav構造からの部門抽出:**

```python
def _extract_departments_from_sort_nav(self, sort_nav, base_url: str) -> Dict[str, str]:
    # 除外するh3見出し
    exclude_headings = [
        "評価項目別", "評価項目",
        "過去のランキング", "過去ランキング",
        "関連ランキング", "関連する"
    ]

    # 各sectionを処理
    for section in sort_nav.find_all("section"):
        h3 = section.find("h3")
        heading_text = h3.get_text(strip=True)

        # 除外対象はスキップ
        if any(exclude in heading_text for exclude in exclude_headings):
            continue

        # リンクテキストを部門名として使用（高精度）
        for link in section.find_all("a", href=True):
            link_text = link.get_text(strip=True)
            departments[dept_path] = link_text
```

**メリット:**
- リンクテキストを直接使用するため、ページ取得が不要（高速化）
- h3見出しで部門カテゴリを正確に識別
- 評価項目や年度リンクを確実に除外

### テスト確認事項

以下のランキングで部門検出が正しく動作することを確認：

| ランキング | 方式 | 部門数 |
|-----------|------|--------|
| 携帯キャリア | sort-nav | 年代別など |
| FX | レガシー | 初心者、スタイル別など |
| ネット証券 | sort-nav | NISA、投資商品別など |
| 子ども英語教室（小学生） | レガシー | 低学年、高学年 |
| SVOD | sort-nav/レガシー | アニメ、洋画など |

### 今後の保守

1. **新ランキング追加時**: sort-navがあれば自動対応、なければ`DEPT_PATTERNS`に追加
2. **オリコンサイト構造変更時**: `EXCLUDE_HEADINGS`の更新を検討
3. **デバッグ**: ログに`sort-nav から X 件の部門を検出`または`レガシーパターンから X 件の部門を検出`が出力される

### v7.0 リファクタリング（レビュー対応）

Gemini AIによるコードレビューで指摘された問題を修正：

#### 1. パフォーマンス改善（Critical）

**問題**: レガシーロジックで部門ごとにHTTPリクエストを発行していた（部門数 × リクエスト）

**修正**: アンカーテキストを直接使用し、HTTPリクエストを削減
```python
# 修正前（非効率）
for dept_path in dept_paths:
    dept_url = f"{self.BASE_URL}/{self.url_prefix}/{dept_path}"
    dept_name = self._extract_page_title_for_dept(dept_url)  # HTTPリクエスト発生
    time.sleep(0.2)

# 修正後（効率的）
for link in all_links:
    dept_name = link.get_text(strip=True)  # HTTPリクエスト不要
    departments[dept_path] = dept_name
```

**効果**: 15部門の場合、15回のHTTPリクエストが0回に削減

#### 2. 定数のクラス変数化（High）

ハードコードされていたパターンをクラス変数として外出し：

| 変数名 | 用途 |
|--------|------|
| `DEPT_PATTERNS` | 部門別リンクの正規表現パターン |
| `EXCLUDE_URL_PATTERNS` | 除外するURLパターン |
| `EXCLUDE_HEADINGS` | sort-nav内で除外するh3見出し |
| `REQUEST_DELAY_SEC` | リクエスト間の遅延（0.2秒） |
| `REQUEST_TIMEOUT_SEC` | タイムアウト（10秒） |
| `MAX_DEPT_NAME_LENGTH` | 部門名の最大文字数（30文字） |

#### 3. 例外処理の具体化（Medium）

```python
# 修正前
except Exception as e:
    logger.warning(f"エラー: {e}")

# 修正後
except RequestException as e:
    logger.warning(f"HTTPエラー: {e}")
except Exception as e:
    logger.error(f"予期せぬエラー: {e}")
```

### テスト結果（v7.0）

| ランキング | 検出方式 | 部門数 | 状態 |
|-----------|---------|--------|------|
| FX | レガシー | 10件 | ✅ |
| ネット証券 | レガシー | 13件 | ✅ |
| 子ども英語教室（小学生） | レガシー | 15件 | ✅ |
| 携帯キャリア | レガシー | 2件 | ✅（プラン別：一般的なプラン、シニア向けプラン）|

**v7.0追加対応**: 携帯キャリアに新設された「プラン別」部門に対応（`plan`パターン追加）

### v7.0 追加改善（セッション後半）

完全自動検出方式の検証で発見された問題を修正：

#### 1. EXCLUDE_URL_PATTERNSの適用範囲拡大

**問題**: `_extract_departments_from_sort_nav()`で`EXCLUDE_URL_PATTERNS`が使用されていなかった

**修正**: sort-navからの抽出でも除外パターンを適用
```python
# 修正前
if "/evaluation-item" in href:
    continue

# 修正後
if any(re.search(pattern, href) for pattern in self.EXCLUDE_URL_PATTERNS):
    continue
```

#### 2. 除外パターンの追加

| パターン | 用途 | 追加理由 |
|---------|------|---------|
| `/company/` | 企業詳細ページ | 部門ではなく個別企業ページ |
| `/education/` | 教育コラムページ | 子ども英語教室のコラムリンク |
| `/how_to` | ハウツー（アンダースコア） | 既存`/howto`の表記揺れ対応 |

#### 3. 検証結果

完全自動検出（`DEPT_PATTERNS`を使用しない方式）の検証：

**結論**: `/company/`リンクが誤検出されるため、完全自動検出は採用せず。

**採用方式**: ハイブリッド（sort-nav優先 + レガシーフォールバック）を維持。

| ランキング | 検出方式 | 部門数 | 主な部門 |
|-----------|---------|--------|---------|
| mobile-carrier | sort-nav → レガシー | 2件 | プラン別（一般、シニア向け） |
| rank_certificate | レガシー | 13件 | スタイル別、デバイス別、投資商品別など |
| svod | レガシー | 13件 | ジャンル別（アニメ、洋画など） |
| kids-english | sort-nav | 2件 | 幼児、小学生 |

**重要**: ネット証券等の`rank_`プレフィックス形式は、slug指定時も`rank_certificate`のように完全な形式で指定する必要がある（`certificate`だけでは`rank-certificate`と解釈されるため）

### v7.0 最終検証結果（2025-12-03）

#### 全ランキング包括テスト

| 指標 | 結果 |
|------|------|
| 総ランキング数 | 215件 |
| OK（成功） | 135件（62.8%） |
| WARN（0件検出） | 80件（37.2%） |
| **ERROR（エラー）** | **0件（0.0%）** |

**✅ 全215ランキングでエラー0件達成**

#### WARNの分析

80件のWARNは以下のカテゴリ：
- 動画配信（ジャンル別）: 10件 - 既にジャンル特化型
- 通信講座・資格スクール: 13件 - 科目別に細分化済み
- 塾（地域・個別指導）: 20件 - 地域別に細分化済み
- その他: 37件 - 部門がないランキング

**結論**: WARNは「部門が存在しないランキング」の正常動作

#### 成功例（部門検出数上位）

| ランキング | 部門数 |
|-----------|--------|
| 中古車情報サイト | 22件 |
| 派遣会社 | 17件 |
| カラオケボックス | 16件 |
| ネット証券 | 13件 |
| 住宅ローン | 12件 |
| FX | 10件 |
| 携帯キャリア | 2件（プラン別新設対応）|

#### レビュー結果

| 観点 | 評価 |
|------|------|
| 機能性 | ✅ 全215ランキングでエラーなし |
| 網羅性 | ✅ 62.8%で部門検出成功 |
| 保守性 | ✅ クラス変数による定数化 |
| パフォーマンス | ✅ HTTPリクエスト最適化済み |
| 安定性 | ✅ 例外処理・リトライ処理完備 |

---

## v7.6 誤検出修正 & 新アーキテクチャ設計 (2025-12-11)

### 背景

v7.5で「evaluation-itemを部門として検出する」変更を実施したが、これは誤りだった。

**問題点:**
1. `evaluation-item` は「評価項目別」であり「部門別」ではない
2. 派遣会社: 福岡県が「おすすめ派遣会社」として誤検出
3. 工場・製造業派遣: 部門が存在しないのにevaluation-itemが部門として検出

### v7.6 修正内容

1. **DEPT_PATTERNS**: `evaluation-item` パターンを削除
2. **EXCLUDE_URL_PATTERNS**: `/evaluation-item` を復元
3. **EXCLUDE_HEADINGS**: 「評価項目別」「評価項目」を復元

### マルチAIレビュー結果

AI Orchestrator v5.2 (Commander/Advisor Model) による分析：

| AI | 役割 | 主な提案 |
|----|------|----------|
| OpenAI o3 | Advisor | キャッシュ＋差分更新、Facade/Feature Flag、リトライ/バックオフ |
| Perplexity | Research | オリコンサイト構造情報は公開情報にないため直接分析が必要 |
| Gemini | Document | 動的判別アプローチは柔軟性・誤検出削減・網羅性で有効 |
| GPT-5 | Reviewer | 具体的な次のステップ（サイト構造の直接分析）を推奨 |

### 新アーキテクチャ設計（将来実装予定）

#### 発見: sort-nav内のtable構造

オリコンサイトの`sort-nav`は`<section>`タグではなく`<table>`構造を使用していることが判明：

```html
<div class="sort-nav sub-content">
  <table>
    <tr>
      <th>評価項目別ランキング</th>
      <td>
        <a href="/evaluation-item/procedure.html">加入手続き</a>
        <a href="/evaluation-item/plan.html">商品内容</a>
        ...
      </td>
    </tr>
    <tr>
      <th>性別別ランキング</th>
      <td>
        <a href="/gender/">男性</a>
        <a href="/gender/woman.html">女性</a>
      </td>
    </tr>
    <tr>
      <th>年代別ランキング</th>
      <td>
        <a href="/age/">10・20代</a>
        <a href="/age/30s.html">30代</a>
        ...
      </td>
    </tr>
  </table>
</div>
```

#### 動的サイト構造解析ロジック

```python
def analyze_ranking_structure(url):
    """ランキングの構造を動的に検出"""
    result = {
        'has_overall': True,
        'evaluation_items': [],  # 評価項目別
        'departments': {},       # 部門別（カテゴリ名: リンク情報）
        'past_years': []         # 過去年度
    }

    # sort-nav内のtableを解析
    for row in sort_nav.find_all('tr'):
        th = row.find('th')  # カテゴリ名
        td = row.find('td')  # リンク一覧

        category_name = th.get_text(strip=True)

        if '評価項目' in category_name:
            # → evaluation_items に追加
        elif '過去' in category_name:
            # → past_years に追加
        else:
            # → departments に追加（性別別、年代別など）
```

#### 検証結果

| ランキング | 評価項目 | 部門カテゴリ | 判定 |
|------------|----------|--------------|------|
| 生命保険 | 4件 | 4種（性別/年代/ライフステージ/契約形態） | ✅ |
| 派遣会社 | 6件 | 6種（性別/年代/雇用形態等） | ✅ |
| 工場製造業派遣 | 6件 | **0種** | ✅ 正しく部門なしと判定 |
| 動画配信サービス | 5件 | 1種（ジャンル別） | ✅ |

#### 将来の実装方針

1. **RankingStructureAnalyzer クラス**: sort-nav table構造を解析
2. **キャッシュ機構**: 初回スキャン結果をJSONでキャッシュ
3. **Feature Flag**: 新旧ロジックの切り替え
4. **段階的移行**: Facade パターンで既存互換性を維持

### テスト結果（v7.6）

```
派遣会社（_staffing）: 25件の部門検出 ✅
  - gender, age, area など（evaluation-itemは含まれない）
工場製造業派遣（_staffing_manufacture）: 0件 ✅
  - 部門別が存在しないランキングで正しく0件
```

### 重要な発見: HANDOVERの記載と実際のサイト構造の乖離

v7.0で実装した `_extract_departments_from_sort_nav()` は `<section>` + `<h3>` 構造を想定していたが、
実際のオリコンサイトは `<table>` + `<th>` 構造を使用していることが判明。

| 項目 | HANDOVERの記載 | 実際のサイト |
|------|----------------|--------------|
| コンテナ | `<nav class="sort-nav">` | `<div class="sort-nav">` |
| 構造 | `<section>` + `<h3>` + `<ul>` | `<table>` + `<th>` + `<td>` |
| sectionタグ | 複数あり | **0個** |
| h3タグ | カテゴリ見出し | **0個** |
| tableタグ | なし | **1個** |

### 全215ランキング包括テスト結果 (2025-12-11)

`test_sort_nav_structure.py` による全ランキングの網羅的検証を実施。

| 構造タイプ | 件数 | 割合 | 説明 |
|-----------|------|------|------|
| **TABLE構造** | 209件 | 97.2% | `<table>` + `<th>` + `<td>` |
| SECTION構造 | **0件** | **0.0%** | `<section>` + `<h3>` + `<ul>` |
| H3_UL構造 | 0件 | 0.0% | `<h3>` + `<ul>` のみ |
| sort-navなし | 6件 | 2.8% | 部門なしランキング |
| エラー | 0件 | 0.0% | - |

**sort-navなしの6ランキング:**

| ランキング名 | slug | URL |
|-------------|------|-----|
| バイク販売店 | bike-sell | rank-bike-sell |
| 電子コミックサービス | manga-apps | rank-manga-apps |
| 格安SIM | mvno | rank-mvno |
| プロバイダ | _internet | rank_internet |
| 映画館 | movie-theater | rank-movie-theater |
| テーマパーク | theme-park | rank-theme-park |

**確定した結論:**
- **SECTION構造は全215ランキング中0件** → HANDOVERの記載は完全に間違っていた
- 詳細結果は `test_sort_nav_results.json` に保存

### v7.7 対応完了 (2025-12-11)

- **sort-nav検出ロジックをTABLE構造に修正** ✅
- `_extract_departments_from_sort_nav()` が実際のサイト構造（`<table>` + `<th>` + `<td>`）に対応
- 旧SECTION構造はフォールバックとして残す（互換性維持）

**テスト結果:**
| ランキング | sort-nav抽出 | get_departments() | 状態 |
|-----------|-------------|-------------------|------|
| FX | 5件 | 5件 | ✅ TABLE構造から抽出 |
| 生命保険 | 4件 | 4件 | ✅ TABLE構造から抽出 |
| ネット証券 | 5件 | 5件 | ✅ TABLE構造から抽出 |
| 自動車保険 | 2件 | 2件 | ✅ TABLE構造から抽出 |
| 携帯キャリア | なし | 7件 | ✅ レガシーで検出 |
| 派遣会社 | 6件 | 6件 | ✅ TABLE構造から抽出 |

---

## 新アーキテクチャ実装方針 (v8.0以降)

### 現状のアーキテクチャ (v7.7)

```
_discover_departments(url)
├─ Phase 1: sort-nav TABLE構造から抽出（v7.7で対応）
│   └─ _extract_departments_from_sort_nav()
│      ├─ TABLE構造を処理 ← v7.7で実装
│      └─ SECTION構造をフォールバック（未使用）
│
└─ Phase 2: レガシー DEPT_PATTERNS（フォールバック）
    └─ URL正規表現パターンマッチング
```

### 新アーキテクチャ設計案

**目標**: 柔軟性・保守性・拡張性の向上

```
┌─────────────────────────────────────────────────────────────────┐
│  SiteStructureAnalyzer (新規)                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 1回のスクレイピングで以下を動的判定:                     │  │
│  │   - 総合ランキングの存在有無                             │  │
│  │   - 評価項目別の存在有無・URL                            │  │
│  │   - 部門別の存在有無・URL・カテゴリ名                    │  │
│  │   - 過去年度ページへの遷移可否                           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                          ↓                                      │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ DepartmentDetector (Facadeパターン)                      │  │
│  │   ├─ SortNavDetector (TABLE構造解析)                     │  │
│  │   ├─ LegacyPatternDetector (DEPT_PATTERNS)               │  │
│  │   └─ Feature Flag で切り替え可能                         │  │
│  └───────────────────────────────────────────────────────────┘  │
│                          ↓                                      │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ Cache Layer (オプション)                                 │  │
│  │   └─ サイト構造情報のキャッシュ・差分更新                │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### 実装フェーズ

| Phase | 内容 | 工数目安 | 優先度 | 詳細 |
|-------|------|----------|--------|------|
| **Phase 0** | v7.7 TABLE構造対応 | - | ✅完了 | sort-navからの部門抽出が動作 |
| **Phase 1** | SiteStructureAnalyzer | 1日 | 高 | sort-nav全体を解析し、総合/評価項目別/部門別を一括判定 |
| **Phase 2** | DepartmentDetector Facade化 | 半日 | 中 | 検出ロジックをクラスに分離 |
| **Phase 3** | Feature Flag導入 | 2時間 | 中 | 新旧ロジックの切り替え機能 |
| **Phase 4** | Cache Layer | 1日 | 低 | サイト構造のキャッシュ・TTL管理 |

### Phase 1: SiteStructureAnalyzer 詳細設計

```python
class SiteStructureAnalyzer:
    """
    sort-navのTABLE構造を解析し、サイト全体の構造を動的に判定
    """

    def analyze(self, url: str) -> SiteStructure:
        """
        Returns:
            SiteStructure(
                has_overall=True,           # 総合ランキング有無
                has_evaluation_items=True,  # 評価項目別有無
                evaluation_item_urls=[...], # 評価項目別URL一覧
                has_departments=True,       # 部門別有無
                department_categories=[     # 部門カテゴリ一覧
                    DepartmentCategory(
                        name="業態別ランキング",
                        departments={"business/": "FX専業", ...}
                    ),
                    ...
                ],
                has_past_years=True,        # 過去年度有無
                available_years=[2024, 2023, ...]
            )
        """
```

### 今後の課題（残り）

1. **prefecture パターン**: 一部のランキングでは都道府県別が有効な部門（引越し会社など）
2. **キャッシュ戦略**: o3提案のキャッシュ＋差分更新ロジック
3. **エラーハンドリング強化**: サイト構造変更時の検知・通知機能

---

## v7.8 sort-nav TABLE構造の複数リンク対応 (2025-12-12)

### 背景

派遣会社（`rank_staffing`）で業務内容別（`type/logistics.html`等）の部門が検出されない不具合が報告された。

### 原因分析

`_extract_departments_from_sort_nav()`のTABLE構造処理で、以下のコードが問題だった:

```python
# 問題のコード（v7.7）
for td in tr.find_all("td"):
    link = td.find("a", href=True)  # ← 最初のリンクのみ取得
```

実際のsort-nav構造では、1つの`<td>`内に複数の`<a>`タグがある:

```html
<tr>
  <th>業務内容別ランキング</th>
  <td>
    <a href="/rank_staffing/type/">オフィス・事務系</a>
    <a href="/rank_staffing/type/call-center.html">コールセンター</a>
    <a href="/rank_staffing/type/logistics.html">物流系</a>  ← 検出されなかった
    ...
  </td>
</tr>
```

### 修正内容

`td.find()` → `td.find_all()` に変更し、TD内のすべてのリンクを取得:

```python
# 修正後のコード（v7.8）
for td in tr.find_all("td"):
    links = td.find_all("a", href=True)  # ← すべてのリンクを取得
    for link in links:
        # 各リンクを処理
```

### テスト結果

**派遣会社（rank_staffing）:**

| 修正前 (v7.7) | 修正後 (v7.8) |
|--------------|---------------|
| 6部門 | **26部門** |

**検出された部門一覧（v7.8）:**

| カテゴリ | 部門 |
|---------|------|
| 年代別 | 20代、30代、40代、50代以上 |
| 性別 | 男性、女性 |
| 地域別 | 東北、関東、近畿、東海、中国・四国、九州・沖縄、甲信越・北陸 |
| 業務内容別 | オフィス・事務系、コールセンター、IT・技術・クリエイティブ系、**物流系**、医療・福祉・介護系、営業・販売系、研究・開発系 |
| 雇用形態 | 短期雇用 |
| 都道府県別 | 愛知県、福岡県、神奈川県、大阪府、東京都 |

**物流系の取得データ（2025年）:**
- 1位: ランスタッド (61.1点)
- 2位: マンパワーグループ (60.9点)
- 3位: スタッフサービス (60.5点)

### 影響範囲

この修正は、sort-nav内に複数リンクを持つすべてのランキングに影響:
- 派遣会社（`rank_staffing`）
- その他のランキングで1つのTD内に複数リンクがあるもの

他のランキング（FX、ネット証券など）では、元々1リンク1TDの構造だったため、影響なし。

---

## v8.4 プレスリリース作成機能強化 (2026-01-23)

### 背景

プレスリリース作成機能は実装済みだが、以下の課題があった：
1. **操作ステップが多い**: Excel + スクレイピング → Word出力まで5クリック必要
2. **手動入力項目が多い**: 見出し、TOPICS、サブ見出しなどを手入力
3. **連携が弱い**: 「文章の自動生成」と「Word出力」が分離、再生成時は手動で「再反映」ボタンが必要

### 実装内容

#### 1. ワンクリック生成機能（release_tab.py v1.2）

プレスリリース作成タブの先頭に「🚀 ワンクリック生成」セクションを追加。

**機能**:
- 年度・発表月日を選択
- 出力オプション（総合表/前年比較/評価項目別/部門別）をチェックボックスで選択
- 「🚀 ワンクリックでWord生成」ボタンで以下を自動実行:
  1. `generate_release()` で文章自動生成
  2. ハイライトからHEADLINE/SUBHEADLINEを自動マッピング
  3. ハイライト→TOPICSタイトル、本文→TOPICS詳細に自動マッピング
  4. `generate_word_release()` でWord生成
  5. ダウンロードボタン表示

**自動マッピングロジック**:
| 項目 | マッピング元 |
|------|-------------|
| HEADLINE | `content.highlights[0]` |
| SUBHEADLINE | `content.highlights[1]` |
| TOPIC 1-3 タイトル | `content.highlights[0-2]` |
| TOPIC 1-3 詳細 | `content.paragraphs[0-2]` |

#### 2. 文章→Word自動連携強化

**改善点**:
- 「📝 文章を生成」実行時に `word_data_synced` フラグを自動クリア
- Word出力タブを開くと自動的に最新の生成結果が反映
- 年度も自動同期（`text_content_year` → `word_synced_year`）
- トースト通知でユーザーにフィードバック

### コード変更箇所

**release_tab.py**:
```python
# 新規追加: _render_quick_release_section() 関数
def _render_quick_release_section(...):
    """ワンクリックでプレスリリースを生成するセクション"""
    # ... 約150行の新規実装

# 修正: 文章生成時に連携フラグをリセット
if st.button("📝 文章を生成", key="generate_text"):
    ...
    st.session_state.pop('word_data_synced', None)  # 追加
    st.success("✅ 文章を生成しました。「Word出力」タブに自動反映されます。")  # 追加

# 修正: Word出力タブの連携ロジック強化
# - forループでTOPICS自動マッピング
# - 年度同期（synced_year_index）
# - トースト通知（st.toast）
```

### 効果

| 項目 | 改善前 | 改善後 |
|------|--------|--------|
| 操作ステップ | 5回 | **1回** |
| 手動入力 | 見出し・TOPICS・詳細 | **自動マッピング** |
| 再生成時の反映 | 手動「再反映」ボタン | **自動反映** |
| 年度の同期 | なし | **自動同期** |

---

## 今後の改善項目（2026-01-23時点）

| 優先度 | 項目 | 概要 | 状態 |
|--------|------|------|------|
| 1 | ワンクリック生成 | Excel + スクレイピング → Word出力を1クリックで | ✅ 完了 |
| 2 | 文章→Word自動連携強化 | 生成時に自動反映、年度同期 | ✅ 完了 |
| 3 | Excel優先ロジック明確化 | アップロードExcelを優先、不足分をWebで補完 | 未着手 |
| 4 | テンプレート外部化（他部署対応） | テンプレート文言をJSON/YAML化、企業マスタのDB化 | 未着手 |

### 他部署転用に向けた準備

プレスリリース作成機能は「オリコン顧客満足度®調査」に特化しているが、以下の変更で他部署（他調査）にも転用可能：

**変更が必要な箇所**:
| 変更項目 | ファイル | 内容 |
|---------|---------|------|
| テンプレート文言 | `release_generator.py:29-87` | 「オリコン顧客満足度®調査」→ 他調査名 |
| タイトル生成 | `release_generator.py:622` | 固定タイトル形式 |
| 企業マスタ | `company_master.py:22-87` | 業種別企業リスト |
| 社名エイリアス | `config/company_aliases.json` | 社名変更マッピング |

**再利用可能な部分（変更不要）**:
| モジュール | 再利用度 |
|-----------|---------|
| `word_generator.py` | 100% |
| `image_generator.py` | 100% |
| `release_generator.py`（TableGenerator等） | 90% |

**推奨改善案**:
1. **短期**: テンプレート文言を `config/release_templates.json` に外部化
2. **中期**: 企業マスタをSQLite/PostgreSQLに移行
3. **長期**: 複数調査対応アーキテクチャへリファクタリング
