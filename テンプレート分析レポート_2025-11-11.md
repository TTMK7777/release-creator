# テンプレート更新分析レポート

**作成日**: 2025年11月11日
**分析対象**:
- **旧**: `C:\Users\t-tsuji\AIアプリ開発\release-creator\テンプレート\【改修中テンプレ】リリース内表 - コピー.xlsx`
- **新**: `C:\Users\t-tsuji\AIアプリ開発\release-creator\テンプレート\テンプレ（変更上書きしないで！）\【テンプレ】リリース内表.xlsx`

---

## 1. 新テンプレートの構成

### シート一覧
1. **総合1つ** - 総合ランキング1つを表示するシート
2. **総合2つ** - 総合ランキング2つを横並びで表示するシート
3. **総合＋前回順位** - 総合ランキングと前回順位を表示するシート
4. **評価・部門別** - 評価項目別および部門別のランキングを表示するシート
5. **複数バージョン** - 複数年度のデータを表示するシート

---

## 2. 前回テンプレートとの差分

### シート数の変更
- **旧**: 5シート
- **新**: 5シート
- **増減**: 変更なし

### 追加されたシート
- **なし**

### 削除されたシート
- **なし**

### 変更されたシート

#### シート「総合1つ」
- **構造変更**: なし（セル範囲・レイアウト維持）
- **サンプルデータ**:
  - 旧: 実データ（携帯キャリア、楽天モバイル等）
  - 新: プレースホルダー（「ランキング名」「あああ」等）

#### シート「総合2つ」
- **構造変更**: なし（セル範囲・レイアウト維持）
- **サンプルデータ**:
  - 旧: 実データ（総合、加入手続き等）
  - 新: プレースホルダー（「ランキング名」「あああ」等）

#### シート「総合＋前回順位 」
- **構造変更**: なし（セル範囲・レイアウト維持）
- **サンプルデータ**:
  - 旧: 実データ（携帯キャリア等）
  - 新: プレースホルダー（「ランキング名」「あああ」等）

#### シート「 評価・部門別 」⚠️ **重要な変更**
- **構造変更**: 最大行数が60行から65行に増加（+5行）
- **変更内容**:
  - 旧: 【部門別用】セクションがB26から始まっていたが、実際には評価項目のデータが入っていた
  - 新: 【部門別用】セクションが正しくB26から始まり、部門別データのための専用エリアが確保された
  - 旧: 評価項目と部門別のレイアウトが混在
  - 新: 評価項目（B6-B24）と部門別（B26-）が明確に分離

- **サンプルデータ**:
  - 旧: 実データ（加入手続き、キャンペーン、通信速度等）
  - 新: プレースホルダー（「あああ」「いいい」等）

#### シート「複数バージョン 」
- **構造変更**: なし（セル範囲・レイアウト維持）
- **サンプルデータ**: 旧・新ともにプレースホルダー（変更なし）

---

## 3. 転記マッピングの変更

### 総合ランキング

#### シート「総合1つ」
| 項目 | 旧 | 新 | 変更有無 |
|---|---|---|---|
| シート名 | 総合1つ | 総合1つ | **同じ** |
| ランキング名セル | C4 | C4 | **同じ** |
| ヘッダー行 | 5行目 (C5:E5) | 5行目 (C5:E5) | **同じ** |
| データ開始行 | 6行目 | 6行目 | **同じ** |
| データ終了行 | 10行目 | 10行目 | **同じ** |
| セル範囲 | C6:E10 | C6:E10 | **同じ** |
| 列構成 | C(順位), D(サービス名), E(得点) | C(順位), D(サービス名), E(得点) | **同じ** |

#### シート「総合2つ」
| 項目 | 旧 | 新 | 変更有無 |
|---|---|---|---|
| シート名 | 総合2つ | 総合2つ | **同じ** |
| **左側ランキング** |
| ランキング名セル | C4 | C4 | **同じ** |
| セル範囲 | C6:E10 | C6:E10 | **同じ** |
| **右側ランキング** |
| ランキング名セル | G4 | G4 | **同じ** |
| セル範囲 | G6:I10 | G6:I10 | **同じ** |

#### シート「総合＋前回順位 」
| 項目 | 旧 | 新 | 変更有無 |
|---|---|---|---|
| シート名 | 総合＋前回順位  | 総合＋前回順位  | **同じ** |
| **左側（前年データ）** |
| 年度表示セル | B3 | B3 | **同じ** |
| ランキング名セル | C9 | C9 | **同じ** |
| セル範囲 | B11:D15 | B11:D15 | **同じ** |
| 列構成 | B(順位), C(サービス名), D(得点) | B(順位), C(サービス名), D(得点) | **同じ** |
| **右側（今年データ＋前回順位）** |
| ランキング名セル | H9 (マージ範囲の一部) | H9 (マージ範囲の一部) | **同じ** |
| セル範囲 | G11:J15 | G11:J15 | **同じ** |
| 列構成 | G(前回順位), H(順位), I(サービス名), J(得点) | G(前回順位), H(順位), I(サービス名), J(得点) | **同じ** |

### 評価項目別 ⚠️ **重要な構造変更**

#### シート「 評価・部門別 」- 評価項目用セクション
| 配置 | 旧セル範囲 | 新セル範囲 | 変更有無 |
|---|---|---|---|
| **【評価項目用】タイトル** | B6 | B6 | **同じ** |
| **年度表示** | B7 | B7 | **同じ** |
| **上段1列目** | B8-D12 (ヘッダー: B8) | B8-D12 (ヘッダー: B8) | **同じ** |
| **上段2列目** | F8-H12 (ヘッダー: F8) | F8-H12 (ヘッダー: F8) | **同じ** |
| **上段3列目** | J8-L12 (ヘッダー: J8) | J8-L12 (ヘッダー: J8) | **同じ** |
| **上段4列目** | N8-P12 (ヘッダー: N8) | N8-P12 (ヘッダー: N8) | **同じ** |
| **中段1列目** | B14-D18 (ヘッダー: B14) | B14-D18 (ヘッダー: B14) | **同じ** |
| **中段2列目** | F14-H18 (ヘッダー: F14) | F14-H18 (ヘッダー: F14) | **同じ** |
| **中段3列目** | J14-L18 (ヘッダー: J14) | J14-L18 (ヘッダー: J14) | **同じ** |
| **中段4列目** | N14-P18 (ヘッダー: N14) | N14-P18 (ヘッダー: N14) | **同じ** |
| **下段1列目** | B19-D23 (ヘッダー: B19) | B19-D23 (ヘッダー: B19) | **同じ** |
| **下段2列目** | F19-H23 (ヘッダー: F19) | F19-H23 (ヘッダー: F19) | **同じ** |
| **下段3列目** | J19-L23 (ヘッダー: J19) | J19-L23 (ヘッダー: J19) | **同じ** |
| **下段4列目** | N19-P23 (ヘッダー: N19) | N19-P23 (ヘッダー: N19) | **同じ** |

**評価項目の配置パターン（4列×3段＝最大12項目）**
```
┌─────────┬─────────┬─────────┬─────────┐
│ B8-D12    │ F8-H12    │ J8-L12    │ N8-P12    │ ← 上段
├─────────┼─────────┼─────────┼─────────┤
│ B14-D18   │ F14-H18   │ J14-L18   │ N14-P18   │ ← 中段
├─────────┼─────────┼─────────┼─────────┤
│ B19-D23   │ F19-H23   │ J19-L23   │ N19-P23   │ ← 下段
└─────────┴─────────┴─────────┴─────────┘
```

#### シート「 評価・部門別 」- 部門別用セクション ⚠️ **新規追加**

| 配置 | 旧セル範囲 | 新セル範囲 | 変更有無 |
|---|---|---|---|
| **【部門別用】タイトル** | **存在しない** | **B26** | **新規追加** |
| **年度表示** | **存在しない** | **B27** | **新規追加** |
| **部門別タイトル** | **存在しない** | **B28** | **新規追加** |
| **上段1列目** | **存在しない** | **B29-D33** | **新規追加** |
| **上段2列目** | **存在しない** | **F29-H33** | **新規追加** |
| **上段3列目** | **存在しない** | **J29-L33** | **新規追加** |
| **上段4列目** | **存在しない** | **N29-P33** | **新規追加** |

**部門別の配置パターン（4列×複数段）**
```
┌─────────┬─────────┬─────────┬─────────┐
│ B29-D33   │ F29-H33   │ J29-L33   │ N29-P33   │ ← 上段
├─────────┼─────────┼─────────┼─────────┤
│ B35-D39   │ F35-H39   │ J35-L39   │ N35-P39   │ ← 中段（推定）
├─────────┼─────────┼─────────┼─────────┤
│ ...       │ ...       │ ...       │ ...       │ ← 下段（推定）
└─────────┴─────────┴─────────┴─────────┘
```

### 複数バージョン

#### シート「複数バージョン 」
| 配置 | 旧セル範囲 | 新セル範囲 | 変更有無 |
|---|---|---|---|
| **上段エリア（2024年）** |
| 年度表示 | B7 | B7 | **同じ** |
| 左上 | B8-D12 | B8-D12 | **同じ** |
| 中上 | F8-H12 | F8-H12 | **同じ** |
| 右上 | J8-L12 | J8-L12 | **同じ** |
| 左中 | B15-D19 | B15-D19 | **同じ** |
| 中中 | F15-H19 | F15-H19 | **同じ** |
| 右中 | J15-L19 | J15-L19 | **同じ** |
| **下段エリア（2024年縦並び）** |
| 年度表示 | B21 | B21 | **同じ** |
| 1段目 | B22-D26 | B22-D26 | **同じ** |
| 2段目 | B28-D32 | B28-D32 | **同じ** |
| 3段目 | B34-D38 | B34-D38 | **同じ** |
| 4段目 | B40-D44 | B40-D44 | **同じ** |

---

## 4. Module2への必要な修正

### ✅ 修正が不要な箇所（そのまま動作）

以下のシート・関数は構造変更がないため、**現行のModule2コードをそのまま使用可能**:

1. **Transfer_Overall_1Column** - シート「総合1つ」の転記
2. **Transfer_Overall_2Columns** - シート「総合2つ」の転記
3. **Transfer_Overall_WithPrevRank** - シート「総合＋前回順位 」の転記

### ⚠️ 修正が必要な箇所

#### 1. **Transfer_EvaluationItems_Dynamic** 関数

**シート「 評価・部門別 」の構造変更に対応が必要**

##### 現状の問題点:
- 旧テンプレートでは、B26以降に評価項目のデータが入っていた
- 新テンプレートでは、B26以降は部門別用セクションになっている
- 評価項目は B6-B24 のエリアに限定されている

##### 必要な修正:

```vba
' 修正前（旧テンプレート用）
Function Transfer_EvaluationItems_Dynamic(...)
    ' 評価項目を探す範囲が広すぎる（B26以降も含まれていた）
    Set evalItemRange = targetWs.Range("B8:B60")
End Function

' 修正後（新テンプレート用）
Function Transfer_EvaluationItems_Dynamic(...)
    ' 評価項目は B8-B24 のエリアに限定
    ' B26以降は【部門別用】セクションなので除外
    Set evalItemRange = targetWs.Range("B8:B24")

    ' 注意: 【部門別用】タイトル（B26）を評価項目として
    ' 誤検出しないように、範囲をB24までに制限
End Function
```

##### 具体的な修正箇所:

**ファイル**: `C:\Users\t-tsuji\AIアプリ開発\release-creator\vba_modules\Module2_Data_Dynamic_SJIS.bas`

**対象関数**: `Transfer_EvaluationItems_Dynamic`

**修正内容**:
```vba
' 行番号 300-350 付近（評価項目を検索する部分）
' 修正前:
Dim maxSearchRow As Long
maxSearchRow = 60  ' 広範囲に検索していた

' 修正後:
Dim maxSearchRow As Long
maxSearchRow = 24  ' B24までに制限（B26以降は部門別用）
```

### 🆕 新規追加が必要な処理

#### 1. **部門別データの転記処理**（オプション）

新テンプレートでは、「 評価・部門別 」シートに部門別用セクション（B26以降）が追加されました。
部門別データを転記する場合は、以下の新規関数が必要です:

```vba
'========================================
' 部門別データ転記（新規）
'========================================
Private Function Transfer_DepartmentRankings_Dynamic( _
    sourceWb As Workbook, _
    targetWb As Workbook, _
    rankingYear As String, _
    rankingName As String _
) As Boolean

    On Error GoTo ErrorHandler
    Transfer_DepartmentRankings_Dynamic = False

    Dim targetWs As Worksheet
    Set targetWs = GetWorksheet(targetWb, " 評価・部門別 ")

    If targetWs Is Nothing Then
        Module1_Main.LogMessage "  [エラー] シート ' 評価・部門別 ' が見つかりません"
        Exit Function
    End If

    ' B27に年度表示を設定
    targetWs.Range("B27").Value = rankingYear & " オリコン顧客満足度®調査 " & _
                                  rankingName & " 部門別ランキング"

    ' B28に部門別タイトル（例: 〇〇別）を設定
    ' この値はソースデータから取得する必要がある

    ' 部門別データの配置パターン（4列×複数段）
    ' 上段: B29-D33, F29-H33, J29-L33, N29-P33
    ' 中段: B35-D39, F35-H39, J35-L39, N35-P39
    ' ...

    ' TODO: ソースデータから部門別ランキングを読み込み、
    '       上記のセル範囲に転記する処理を実装

    Transfer_DepartmentRankings_Dynamic = True
    Exit Function

ErrorHandler:
    Module1_Main.LogMessage "  [エラー] 部門別データ転記中にエラー: " & Err.Description
    Transfer_DepartmentRankings_Dynamic = False
End Function
```

**注意**: 部門別データの転記が不要な場合は、この処理は実装不要です。

### ❌ 削除すべき処理

**なし** - 既存の処理はすべて維持できます。

---

## 5. 推奨アクション

### 🔴 必須（即座に実施）

- [x] **シート「 評価・部門別 」の構造変更を確認**
  - 新テンプレートでは評価項目がB8-B24に限定されている
  - B26以降は部門別用セクションになっている

- [ ] **Module2_Data_Dynamic_SJIS.bas の修正**
  - `Transfer_EvaluationItems_Dynamic` 関数で評価項目の検索範囲を B8-B24 に制限
  - 具体的には `maxSearchRow = 24` に変更

- [ ] **修正後のテスト実施**
  - 新テンプレートで評価項目の転記が正しく動作するか確認
  - 【部門別用】タイトル（B26）が誤って評価項目として検出されないか確認

### 🟡 推奨（必要に応じて実施）

- [ ] **部門別データ転記の要否を確認**
  - 部門別データを転記する必要があるか確認
  - 必要な場合は `Transfer_DepartmentRankings_Dynamic` 関数を実装

- [ ] **サンプルデータのクリア処理を追加**
  - 新テンプレートには「あああ」「いいい」などのプレースホルダーが入っている
  - 転記前にこれらをクリアする処理を追加するか検討

- [ ] **ドキュメントの更新**
  - 新テンプレートの構造変更をドキュメントに反映
  - 評価項目と部門別の配置ルールを明記

### 🟢 任意（時間があれば実施）

- [ ] **旧テンプレートとの互換性維持**
  - 旧テンプレートでも動作するように、自動判定機能を追加
  - B26セルの値を確認し、「【部門別用】」なら新テンプレート、それ以外なら旧テンプレートと判定

- [ ] **エラーハンドリングの強化**
  - 評価項目が12個を超える場合の警告
  - セル範囲外のデータを検出した場合の警告

---

## 6. まとめ

### 変更の影響度

| シート | 構造変更 | Module2への影響 | 対応優先度 |
|---|---|---|---|
| 総合1つ | なし | なし | - |
| 総合2つ | なし | なし | - |
| 総合＋前回順位  | なし | なし | - |
| **評価・部門別** | **あり（+5行）** | **あり（要修正）** | **🔴 高** |
| 複数バージョン  | なし | なし | - |

### 最小限の修正内容

**1箇所のみ修正すれば動作します**:

```vba
' ファイル: Module2_Data_Dynamic_SJIS.bas
' 関数: Transfer_EvaluationItems_Dynamic

' 変更箇所: 評価項目の検索範囲を制限
maxSearchRow = 24  ' 旧: 60 → 新: 24
```

この修正により、新テンプレートの【部門別用】セクション（B26以降）を誤って
評価項目として検出することを防ぎます。

---

## 付録: 詳細なセル配置図

### シート「 評価・部門別 」- 新テンプレート

```
行番号  A    B       C       D       E    F       G       H       I    J       K       L       M    N       O       P
────────────────────────────────────────────────────────────────────────────────────────────────────────────────
1
2
3
4
5
6            【評価項目用】
7            2025年 オリコン顧客満足度®調査 ランキング名 評価項目別ランキング
8            あああ                              あああ                              あああ                              あああ
9            順位    サービス名  得点                順位    サービス名  得点                順位    サービス名  得点                順位    サービス名  得点
10           1位     あああ      0                   1位     あああ      0                   1位     あああ      0                   1位     あああ      0
11           2位     いいい      0                   2位     いいい      0                   2位     いいい      0                   2位     いいい      0
12           3位     ううう      0                   3位     ううう      0                   3位     ううう      0                   3位     ううう      0
13
14           あああ                              あああ                              あああ                              あああ
15           順位    サービス名  得点                順位    サービス名  得点                順位    サービス名  得点                順位    サービス名  得点
16           1位     あああ      0                   1位     あああ      0                   1位     あああ      0                   1位     あああ      0
17           2位     いいい      0                   2位     いいい      0                   2位     いいい      0                   2位     いいい      0
18           3位     ううう      0                   3位     ううう      0                   3位     ううう      0                   3位     ううう      0
19           あああ                              あああ                              あああ                              あああ
20           順位    サービス名  得点                順位    サービス名  得点                順位    サービス名  得点                順位    サービス名  得点
21           1位     あああ      0                   1位     あああ      0                   1位     あああ      0                   1位     あああ      0
22           2位     いいい      0                   2位     いいい      0                   2位     いいい      0                   2位     いいい      0
23           3位     ううう      0                   3位     ううう      0                   3位     ううう      0                   3位     ううう      0
24                                                                                                                   ※上記順位以降はサイトに
25
26           【部門別用】 ← ⚠️ ここから部門別セクション（新規追加）
27           2025年 オリコン顧客満足度®調査 ランキング名 部門別ランキング
28           〇〇別
29           あああ                              いいい                              あああ                              いいい
30           順位    サービス名  得点                順位    サービス名  得点                順位    サービス名  得点                順位    サービス名  得点
31           1位     あああ      0                   1位     いいい      0                   1位     あああ      0                   1位     いいい      0
32           2位     あああ      0                   2位     いいい      0                   2位     あああ      0                   2位     いいい      0
33           3位     あああ      0                   3位     いいい      0                   3位     あああ      0                   3位     いいい      0
34
35           ううう                              えええ                              ううう                              えええ
36           順位    サービス名  得点                順位    サービス名  得点                順位    サービス名  得点                順位    サービス名  得点
37           1位     ううう      0                   1位     えええ      0                   1位     ううう      0                   1位     えええ      0
38           2位     ううう      0                   2位     えええ      0                   2位     ううう      0                   2位     えええ      0
39           3位     ううう      0                   3位     えええ      0                   3位     ううう      0                   3位     えええ      0
...
65
```

---

**レポート完了**
