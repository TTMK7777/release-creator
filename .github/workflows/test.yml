name: ãƒ†ã‚¹ãƒˆè‡ªå‹•å®Ÿè¡Œ

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Pythonã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install pytest pytest-cov

    - name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      id: test
      continue-on-error: true
      run: |
        if [ -d "tests" ] || [ -d "test" ]; then
          pytest tests/ test/ -v --cov=. --cov-report=xml --cov-report=term --junitxml=test-results.xml 2>&1 | tee test-output.txt
        else
          echo "ãƒ†ã‚¹ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚" | tee test-output.txt
          exit 0
        fi

    - name: ãƒ†ã‚¹ãƒˆçµæœã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          test-results.xml
          test-output.txt
          .coverage

    - name: ã‚¨ãƒ©ãƒ¼æ™‚ã«è©³ç´°Issueã‚’ä½œæˆï¼ˆClaude Codeç”¨ï¼‰
      if: failure() && github.event_name == 'push'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          let testOutput = '';
          let errorSummary = '';

          if (fs.existsSync('test-results.xml')) {
            const testResults = fs.readFileSync('test-results.xml', 'utf8');
            const errorMatches = testResults.match(/<failure[^>]*>([\s\S]*?)<\/failure>/g);
            if (errorMatches) {
              errorSummary = errorMatches.slice(0, 5).map(m => {
                const msg = m.match(/<failure[^>]*>([\s\S]*?)<\/failure>/)[1];
                return msg.substring(0, 500);
              }).join('\n\n---\n\n');
            }
          }

          if (fs.existsSync('test-output.txt')) {
            testOutput = fs.readFileSync('test-output.txt', 'utf8');
            const lines = testOutput.split('\n');
            testOutput = lines.slice(-100).join('\n');
          }

          const commit = await github.rest.repos.getCommit({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: context.sha
          });

          const commitMessage = commit.data.commit.message;
          const commitAuthor = commit.data.commit.author.name;
          const changedFiles = commit.data.files.map(f => f.filename).join(', ');

          const issueTitle = `[è‡ªå‹•ä¿®æ­£] ãƒ†ã‚¹ãƒˆå¤±æ•—: ${context.sha.substring(0, 7)}`;
          const issueBody = `## ğŸ”´ ãƒ†ã‚¹ãƒˆå¤±æ•— - Claude Codeã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£ãŒå¿…è¦ã§ã™

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—
**ã‚³ãƒŸãƒƒãƒˆ**: \`${context.sha.substring(0, 7)}\`
**ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: ${commitMessage.split('\n')[0]}
**ä½œæˆè€…**: ${commitAuthor}
**å®Ÿè¡Œæ—¥æ™‚**: ${new Date().toISOString()}
**ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: [${context.workflow}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

### ğŸ“ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
\`\`\`
${changedFiles || 'ä¸æ˜'}
\`\`\`

### âŒ ã‚¨ãƒ©ãƒ¼ã‚µãƒãƒªãƒ¼
${errorSummary ? `\`\`\`\n${errorSummary.substring(0, 2000)}\n\`\`\`` : 'ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ'}

### ğŸ“‹ ãƒ†ã‚¹ãƒˆå‡ºåŠ›ï¼ˆæœ€å¾Œ100è¡Œï¼‰
\`\`\`
${testOutput.substring(0, 3000)}
\`\`\`

### ğŸ¤– Claude Codeã¸ã®æŒ‡ç¤º

ã“ã®Issueã‚’èª­ã¿å–ã£ã¦ã€ä»¥ä¸‹ã®æ‰‹é †ã§ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š

1. **ã‚¨ãƒ©ãƒ¼åŸå› ã®ç‰¹å®š**: ä¸Šè¨˜ã®ã‚¨ãƒ©ãƒ¼ã‚µãƒãƒªãƒ¼ã¨ãƒ†ã‚¹ãƒˆå‡ºåŠ›ã‚’åˆ†æ
2. **ä¿®æ­£ã®å®Ÿè£…**: ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…
3. **ãƒ†ã‚¹ãƒˆã®ç¢ºèª**: ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ç¢ºèª
4. **ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥**: ä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥
5. **å†ãƒ†ã‚¹ãƒˆ**: GitHub ActionsãŒè‡ªå‹•ã§å†ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ

### âœ… ä¿®æ­£å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] ã‚¨ãƒ©ãƒ¼åŸå› ã‚’ç‰¹å®š
- [ ] ä¿®æ­£ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆæˆåŠŸã‚’ç¢ºèª
- [ ] ä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥
- [ ] GitHub Actionsã§å†ãƒ†ã‚¹ãƒˆæˆåŠŸã‚’ç¢ºèª

---
*ã“ã®Issueã¯GitHub Actionsã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚Claude CodeãŒè‡ªå‹•ä¿®æ­£ã‚’è©¦ã¿ã¾ã™ã€‚*`;

          const existingIssues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'auto-fix',
            per_page: 10
          });

          const existingIssue = existingIssues.data.find(issue =>
            issue.title.includes(context.sha.substring(0, 7))
          );

          if (existingIssue) {
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: issueBody,
              state: 'open'
            });
            console.log(`æ—¢å­˜ã®Issue #${existingIssue.number} ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
          } else {
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: issueBody,
              labels: ['bug', 'automated', 'test-failure', 'auto-fix']
            });
            console.log(`æ–°ã—ã„Issue #${issue.data.number} ã‚’ä½œæˆã—ã¾ã—ãŸ`);
          }

    - name: ãƒ†ã‚¹ãƒˆæˆåŠŸæ™‚ã«auto-fix Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
      if: success() && github.event_name == 'push'
      uses: actions/github-script@v7
      with:
        script: |
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'auto-fix',
            per_page: 10
          });

          for (const issue of issues.data) {
            const commit = await github.rest.repos.getCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `## âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸï¼ä¿®æ­£å®Œäº†

**ã‚³ãƒŸãƒƒãƒˆ**: \`${context.sha.substring(0, 7)}\`
**å®Ÿè¡Œæ—¥æ™‚**: ${new Date().toISOString()}

ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸã€‚ã“ã®Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™ã€‚`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed'
            });

            console.log(`Issue #${issue.number} ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã—ãŸ`);
          }
