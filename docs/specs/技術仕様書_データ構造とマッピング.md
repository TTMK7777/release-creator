# 技術仕様書 - データ構造とマッピング定義

**バージョン:** 1.0  
**作成日:** 2025年11月10日  
**対象ファイル分析結果に基づく正確な仕様**

---

## 1. 元データExcelの構造

### 1.1 ファイル情報
- **ファイル名:** `_資料_携帯キャリア_ランキング結果2024.xlsx`
- **シート数:** 5 (総合対象企業, 評価項目, 評価項目_営業用, 他者推奨意向, 継続意向)

### 1.2 シート: 総合対象企業

**データ範囲:** A1:R8

#### 列定義

| 列番号 | 列名 | データ型 | 説明 | サンプル値 |
|--------|------|---------|------|-----------|
| A | 順位 | Integer | ランキング順位 | 1, 2, 3, 4 |
| B | ID | Integer | 企業識別番号 | 6, 4, 1, 5 |
| C | ランキング対象企業名 | String | 企業名(正式名称) | "楽天モバイル", "au", "docomo", "SoftBank" |
| D | 回答者数 | Integer | 総回答者数 | 1502, 1723, 3785, 1454 |
| E | 回答者数(最新年) | Integer | 最新年度の回答者数 | 1502, 1723, 3785, 1454 |
| F | 標準偏差 | Double | 統計値 | 13.87545, 14.989419 |
| G | 合計 | Double | **総合得点(重要)** | 69.52, 66.85, 66.55, 66.18 |
| H | 加入手続き | Double | 評価項目得点 | 73.26, 69.88, 70.42, 69.33 |
| I | キャンペーン | Double | 評価項目得点 | 71.77, 66.04, 64.71, 66.22 |
| J | 初期設定のしやすさ | Double | 評価項目得点 | 72.66, 68.93, 68.12, 68.15 |
| K | 通信速度 | Double | 評価項目得点 | 68.22, 71.52, 71.22, 70.40 |
| L | 料金プラン | Double | 評価項目得点 | 73.34, 65.85, 66.15, 65.41 |
| M | 端末のラインナップ | Double | 評価項目得点 | 64.17, 64.99, 64.09, 64.50 |
| N | 利用料金 | Double | 評価項目得点 | 69.56, 65.66, 65.48, 65.03 |
| O | サポートサービス | Double | 評価項目得点 | 65.21, 65.01, 64.55, 63.96 |
| P | 付帯サービス | Double | 評価項目得点 | 69.30, 66.59, 66.28, 65.78 |
| Q | 他者推奨得点 | Double | NPS系指標 | 67.15, 63.74, 64.06, 62.79 |
| R | 非お薦め率 | Double | ネガティブ指標 | 0.065912, 0.10679 |

#### データ開始行
- **ヘッダー行:** 4行目
- **データ開始行:** 5行目
- **データ終了行:** 8行目(4企業分)

#### VBAでのアクセス例
```vba
' 1位の企業名を取得
企業名 = ws.Cells(5, 3).Value  ' "楽天モバイル"

' 1位の総合得点を取得
得点 = ws.Cells(5, 7).Value    ' 69.520559

' 全ランキングをループ
For i = 5 To 8
    順位 = ws.Cells(i, 1).Value
    企業名 = ws.Cells(i, 3).Value
    総合得点 = ws.Cells(i, 7).Value
    Debug.Print 順位 & "位: " & 企業名 & " (" & 総合得点 & "点)"
Next i
```

### 1.3 シート: 評価項目

**データ範囲:** A1:F56

#### 列定義

| 列番号 | 列名 | データ型 | 説明 |
|--------|------|---------|------|
| A | 評価項目 | String | 項目名 |
| B | 順位 | Integer | 項目内順位 |
| C | ID | Integer | 企業ID |
| D | ランキング対象企業名 | String | 企業名 |
| E | スコア | Double | 項目得点 |
| F | n数 | Integer | 回答者数 |

#### 評価項目リスト(9項目)
1. 加入手続き
2. キャンペーン
3. 初期設定のしやすさ
4. 通信速度
5. 料金プラン
6. 端末のラインナップ
7. 利用料金
8. サポートサービス
9. 付帯サービス

#### データ構造
```
行5-8:   加入手続き (1-4位)
行9:     空行
行10-13: キャンペーン (1-4位)
行14:    空行
...
(各評価項目が4行ずつ + 空行1行)
```

#### VBAでのアクセス例
```vba
' 「加入手続き」の1位を取得
For i = 5 To 56
    If ws.Cells(i, 1).Value = "加入手続き" And _
       ws.Cells(i, 2).Value = 1 Then
        企業名 = ws.Cells(i, 4).Value
        得点 = ws.Cells(i, 5).Value
        Exit For
    End If
Next i
```

---

## 2. リリース内表Excelの構造

### 2.1 ファイル情報
- **ファイル名:** `2025年リフォーム_リリース内表.xlsx`
- **シート数:** 8

### 2.2 シート: 総合3つ

**データ範囲:** A1:T54

#### 重要セル定義

| セル | 内容 | データ型 | 現在の値(例) |
|------|------|---------|-------------|
| B5 | メインタイトル | String | "2025年 オリコン顧客満足度®調査 『リフォーム』 総合ランキング" |
| B7 | カテゴリ1ヘッダー | String | "フルリフォーム (回答者数：2,650名)" |
| F7 | カテゴリ2ヘッダー | String | "マンションリフォーム (回答者数：5,774名)" |
| J7 | カテゴリ3ヘッダー | String | "戸建てリフォーム (回答者数：17,540名)" |

#### データテーブル構造

**カテゴリ1(フルリフォーム): B列-D列**
| 行 | B列(順位) | C列(サービス名) | D列(得点) |
|----|----------|----------------|----------|
| 8 | "順位" | "サービス名" | "得点" |
| 9 | "1位" | [データ] | [データ] |
| 10 | "2位" | [データ] | [データ] |
| 11 | "3位" | [データ] | [データ] |

**カテゴリ2(マンション): F列-H列**
| 行 | F列(順位) | G列(サービス名) | H列(得点) |
|----|----------|----------------|----------|
| 8 | "順位" | "サービス名" | "得点" |
| 9-11 | データ行 | データ行 | データ行 |

**カテゴリ3(戸建て): J列-L列**
| 行 | J列(順位) | K列(サービス名) | L列(得点) |
|----|----------|----------------|----------|
| 8 | "順位" | "サービス名" | "得点" |
| 9-11 | データ行 | データ行 | データ行 |

#### VBAでのアクセス例
```vba
' カテゴリ1の1位データを書き込み
With ws
    .Cells(9, 2).Value = "1位"
    .Cells(9, 3).Value = "住友林業のリフォーム"
    .Cells(9, 4).Value = 77.08
End With

' 全カテゴリの1位を取得
Dim cat1_1位 As String
Dim cat2_1位 As String
Dim cat3_1位 As String

cat1_1位 = ws.Cells(9, 3).Value  ' B列
cat2_1位 = ws.Cells(9, 7).Value  ' F列
cat3_1位 = ws.Cells(9, 11).Value ' J列
```

### 2.3 シート: フルリフォーム 評価項目別

**データ範囲:** B8:X30

#### 構造
- 横方向に評価項目が並ぶ(4列ごと)
- 各評価項目で順位、サービス名、得点を表示

```
B8-D8: 評価項目1 (営業担当者の接客力)
F8-H8: 評価項目2 (営業担当者の提案力)
J8-L8: 評価項目3 (施工担当者の対応)
...
```

---

## 3. データマッピング定義

### 3.1 総合ランキング転記

#### 元データ → リリース内表

| 元データ | リリース内表 | 変換処理 |
|---------|-------------|---------|
| Cells(5, 1) = 1 | Cells(9, 2) = "1位" | 文字列変換 |
| Cells(5, 3) = "楽天モバイル" | Cells(9, 3) = "楽天モバイル" | そのまま |
| Cells(5, 7) = 69.520559 | Cells(9, 4) = 69.5 | Round(x, 1) |

#### VBA実装例
```vba
Sub 総合ランキング転記(元ws As Worksheet, リリースws As Worksheet)
    Dim i As Long
    Dim 転記先Row As Long
    
    転記先Row = 9 ' リリース表の開始行
    
    ' 上位3位をループ
    For i = 5 To 7
        With リリースws
            ' 順位
            .Cells(転記先Row, 2).Value = (i - 4) & "位"
            
            ' サービス名
            .Cells(転記先Row, 3).Value = 元ws.Cells(i, 3).Value
            
            ' 得点(小数点1桁)
            .Cells(転記先Row, 4).Value = Round(元ws.Cells(i, 7).Value, 1)
        End With
        
        転記先Row = 転記先Row + 1
    Next i
End Sub
```

### 3.2 評価項目別転記

#### ロジック
1. 元データの「評価項目」シートから各項目の1位を抽出
2. リリース内表の該当位置に配置

#### VBA実装例
```vba
Sub 評価項目別転記(元ws As Worksheet, リリースws As Worksheet)
    
    ' 評価項目リスト
    Dim 項目リスト As Variant
    項目リスト = Array("加入手続き", "キャンペーン", "初期設定のしやすさ", _
                      "通信速度", "料金プラン", "端末のラインナップ", _
                      "利用料金", "サポートサービス", "付帯サービス")
    
    Dim 項目 As Variant
    Dim リリース列 As Long
    リリース列 = 2 ' B列から開始
    
    For Each 項目 In 項目リスト
        ' 元データから該当項目の1位を検索
        Dim row As Long
        For row = 5 To 56
            If 元ws.Cells(row, 1).Value = 項目 And _
               元ws.Cells(row, 2).Value = 1 Then
                
                ' リリース表に書き込み
                With リリースws
                    .Cells(10, リリース列).Value = "1位"
                    .Cells(11, リリース列).Value = 元ws.Cells(row, 4).Value
                    .Cells(12, リリース列).Value = Round(元ws.Cells(row, 5).Value, 1)
                End With
                
                Exit For
            End If
        Next row
        
        ' 次の項目列へ(4列ごと)
        リリース列 = リリース列 + 4
    Next 項目
    
End Sub
```

---

## 4. 画像生成仕様

### 4.1 総合ランキング表の画像化

#### 対象範囲
- **シート:** 総合3つ
- **セル範囲:** B7:D20 (調整可能)
- **出力ファイル名:** `総合ランキング.png`

#### コード実装
```vba
Sub 総合ランキング画像化(wb As Workbook, 出力フォルダ As String)
    
    Dim ws As Worksheet
    Set ws = wb.Worksheets("総合3つ")
    
    ' 画像化する範囲
    Dim rng As Range
    Set rng = ws.Range("B7:D20")
    
    ' クリップボードにコピー
    rng.CopyPicture Appearance:=xlScreen, Format:=xlPicture
    
    ' 一時ChartObjectを作成
    Dim cht As ChartObject
    Set cht = ws.ChartObjects.Add( _
        Left:=rng.Left, _
        Top:=rng.Top, _
        Width:=rng.Width, _
        Height:=rng.Height)
    
    ' Chartに貼り付け
    With cht.Chart
        .Paste
        
        ' PNG出力
        .Export Filename:=出力フォルダ & "総合ランキング.png", _
                FilterName:="PNG"
    End With
    
    ' ChartObject削除(クリーンアップ)
    cht.Delete
    
    Set cht = Nothing
    Set rng = Nothing
    Set ws = Nothing
    
End Sub
```

### 4.2 評価項目別表の画像化

#### 対象範囲
- **シート:** フルリフォーム 評価項目別
- **セル範囲:** B8:X30
- **出力ファイル名:** `評価項目別ランキング.png`

#### コード実装
```vba
Sub 評価項目別画像化(wb As Workbook, 出力フォルダ As String)
    
    Dim ws As Worksheet
    Set ws = wb.Worksheets("フルリフォーム 評価項目別")
    
    Dim rng As Range
    Set rng = ws.Range("B8:X30")
    
    rng.CopyPicture Appearance:=xlScreen, Format:=xlPicture
    
    Dim cht As ChartObject
    Set cht = ws.ChartObjects.Add( _
        Left:=rng.Left, _
        Top:=rng.Top, _
        Width:=rng.Width, _
        Height:=rng.Height)
    
    With cht.Chart
        .Paste
        .Export Filename:=出力フォルダ & "評価項目別ランキング.png", _
                FilterName:="PNG"
    End With
    
    cht.Delete
    
End Sub
```

---

## 5. Word操作仕様

### 5.1 Wordテンプレート構造(推定)

**ファイル名:** `2023年12月発表__携帯キャリア_..._ニュースリリース__.docx`

#### 主要要素
1. **ヘッダー**
   - "NEWS RELEASE" テキスト
   - ORICONロゴ画像
   - 発表日(例: "2025年11月4日")

2. **タイトル部**
   - メインタイトル(赤字・大きめフォント)
   - サブタイトル(青字)

3. **本文**
   - リード文
   - 【TOPICS】セクション
   - 詳細説明
   - 調査概要

4. **画像**
   - 総合ランキング表
   - 評価項目別ランキング表

5. **フッター**
   - お問い合わせ先

### 5.2 日付更新処理

#### 処理内容
- 文書内の全ての "2024年" → "2025年" に置換
- 文書内の全ての "2023年" → "2024年" に置換
- 発表日を今日の日付に更新

#### コード実装
```vba
Sub Word日付更新(wdDoc As Object)
    
    ' 2024年 → 2025年
    With wdDoc.Content.Find
        .ClearFormatting
        .Replacement.ClearFormatting
        .Text = "2024年"
        .Replacement.Text = "2025年"
        .Forward = True
        .Wrap = 1 ' wdFindContinue
        .Format = False
        .MatchCase = False
        .Execute Replace:=2 ' wdReplaceAll
    End With
    
    ' 2023年 → 2024年
    With wdDoc.Content.Find
        .Text = "2023年"
        .Replacement.Text = "2024年"
        .Execute Replace:=2
    End With
    
    ' 発表日を今日の日付に
    Dim 今日 As String
    今日 = Format(Now, "yyyy年m月d日")
    
    ' 曜日付きの日付パターンを置換
    ' 例: "2024年11月4日(火)" → "2025年11月10日(月)"
    今日 = 今日 & "(" & Format(Now, "aaa") & ")"
    
    With wdDoc.Content.Find
        .Text = "202[0-9]年[0-9]{1,2}月[0-9]{1,2}日"
        .MatchWildcards = True
        .Replacement.Text = 今日
        .Execute Replace:=2
    End With
    
End Sub
```

### 5.3 タイトル更新処理

#### タイトル生成ルール

```vba
Function タイトル生成(企業名 As String, 連続年数 As Integer) As String
    
    Dim title As String
    
    Select Case 連続年数
        Case Is >= 3
            title = "【" & 企業名 & "】が" & 連続年数 & "年連続総合1位に"
        Case 2
            title = "【" & 企業名 & "】が2年連続総合1位を獲得"
        Case 1
            title = "【" & 企業名 & "】が総合1位を獲得"
        Case Else
            title = "【" & 企業名 & "】がランキング上位に"
    End Select
    
    タイトル生成 = title
    
End Function
```

#### Word内でのタイトル置換

```vba
Sub Wordタイトル更新(wdDoc As Object, 新タイトル As String)
    
    Dim para As Object
    
    ' 赤字の大見出しを探す
    For Each para In wdDoc.Paragraphs
        
        ' 【】を含む段落で、"総合1位"を含む場合
        If InStr(para.Range.Text, "【") > 0 And _
           InStr(para.Range.Text, "総合1位") > 0 Then
            
            ' テキストを置換
            para.Range.Text = 新タイトル
            
            ' フォント設定を維持
            With para.Range.Font
                .Size = 16  ' 適切なサイズに調整
                .Bold = True
                .Color = RGB(255, 0, 0)  ' 赤色
            End With
            
            Exit For
        End If
    Next para
    
End Sub
```

### 5.4 本文更新処理

#### 本文テンプレート
```vba
Function 本文生成(データ As Dictionary) As String
    
    Dim 本文 As String
    
    本文 = "オリコン株式会社(本社:東京都港区 代表取締役社長:小池 恒)は、" & vbCrLf
    本文 = 本文 & データ("調査対象") & "に対して" & vbCrLf
    本文 = 本文 & "年1回の満足度調査「オリコン顧客満足度®調査」を実施し、" & vbCrLf
    本文 = 本文 & Format(Now, "yyyy年m月d日") & "(火) 14時に" & vbCrLf
    本文 = 本文 & "調査結果を公式サイト内にて発表しました。" & vbCrLf
    本文 = 本文 & vbCrLf
    本文 = 本文 & "ランキングの結果は、下記の通りとなりました。" & vbCrLf
    本文 = 本文 & vbCrLf
    本文 = 本文 & "【TOPICS】" & vbCrLf
    
    ' TOPICSを追加
    Dim topic As Variant
    For Each topic In データ("TOPICS")
        本文 = 本文 & "■" & topic & vbCrLf
    Next topic
    
    本文 = 本文 & vbCrLf
    本文 = 本文 & "本調査は、" & データ("調査期間") & "に" & vbCrLf
    本文 = 本文 & データ("調査対象詳細") & "の" & vbCrLf
    本文 = 本文 & "無料相談を利用した" & データ("回答者数") & "人を対象に、" & vbCrLf
    本文 = 本文 & "インターネットによるアンケートを実施しました。" & vbCrLf
    
    本文生成 = 本文
    
End Function
```

### 5.5 画像差し替え処理

#### InlineShapesを利用した差し替え

```vba
Sub Word画像差し替え(wdDoc As Object, 画像Path As String, 画像番号 As Integer)
    
    On Error Resume Next
    
    ' 既存の画像を削除
    If wdDoc.InlineShapes.Count >= 画像番号 Then
        wdDoc.InlineShapes(画像番号).Delete
    End If
    
    On Error GoTo 0
    
    ' 画像を挿入する位置を特定
    ' (例: 特定のキーワードの後)
    Dim 挿入位置 As Object
    
    If 画像番号 = 1 Then
        ' 総合ランキング画像は「下記の通り」の後
        Set 挿入位置 = wdDoc.Range
        挿入位置.Find.Execute FindText:="下記の通り"
        
        If 挿入位置.Find.Found Then
            挿入位置.Collapse Direction:=0 ' wdCollapseEnd
            挿入位置.InsertParagraphAfter
        End If
        
    ElseIf 画像番号 = 2 Then
        ' 評価項目別画像は「<ランキング概要>」の前
        Set 挿入位置 = wdDoc.Range
        挿入位置.Find.Execute FindText:="<ランキング概要>"
        
        If 挿入位置.Find.Found Then
            挿入位置.Collapse Direction:=1 ' wdCollapseStart
            挿入位置.InsertParagraphBefore
        End If
    End If
    
    ' 画像を挿入
    If Not 挿入位置 Is Nothing Then
        挿入位置.InlineShapes.AddPicture _
            Filename:=画像Path, _
            LinkToFile:=False, _
            SaveWithDocument:=True
    End If
    
End Sub
```

---

## 6. エラーハンドリング

### 6.1 ファイル存在チェック

```vba
Function ファイル存在チェック(filePath As String) As Boolean
    ファイル存在チェック = (Dir(filePath) <> "")
End Function

' 使用例
If Not ファイル存在チェック(元DataPath) Then
    MsgBox "元データファイルが見つかりません: " & 元DataPath, vbCritical
    Exit Sub
End If
```

### 6.2 シート存在チェック

```vba
Function シート存在チェック(wb As Workbook, sheetName As String) As Boolean
    Dim ws As Worksheet
    
    On Error Resume Next
    Set ws = wb.Worksheets(sheetName)
    シート存在チェック = Not ws Is Nothing
    On Error GoTo 0
End Function
```

### 6.3 データ整合性チェック

```vba
Function データ整合性チェック(ws As Worksheet) As Boolean
    
    ' 最低限のデータが存在するか
    If ws.Cells(5, 1).Value <> 1 Then
        MsgBox "ランキング1位のデータが見つかりません", vbExclamation
        データ整合性チェック = False
        Exit Function
    End If
    
    If ws.Cells(5, 3).Value = "" Then
        MsgBox "企業名が空です", vbExclamation
        データ整合性チェック = False
        Exit Function
    End If
    
    If ws.Cells(5, 7).Value = 0 Then
        MsgBox "得点データが不正です", vbExclamation
        データ整合性チェック = False
        Exit Function
    End If
    
    データ整合性チェック = True
    
End Function
```

### 6.4 エラーログ出力

```vba
Sub エラーログ出力(errMsg As String)
    
    Dim logPath As String
    logPath = ThisWorkbook.Path & "\error_log.txt"
    
    Dim fileNum As Integer
    fileNum = FreeFile
    
    Open logPath For Append As #fileNum
    Print #fileNum, Format(Now, "yyyy-mm-dd hh:nn:ss") & " - " & errMsg
    Close #fileNum
    
End Sub
```

---

## 7. パフォーマンス最適化

### 7.1 画面更新の抑制

```vba
Sub 高速化設定()
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    Application.Calculation = xlCalculationManual
    Application.EnableEvents = False
End Sub

Sub 高速化解除()
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True
    Application.Calculation = xlCalculationAutomatic
    Application.EnableEvents = True
End Sub
```

### 7.2 オブジェクト解放

```vba
Sub オブジェクトクリーンアップ()
    
    ' Workbookオブジェクトの解放
    If Not wb Is Nothing Then
        wb.Close SaveChanges:=False
        Set wb = Nothing
    End If
    
    ' Wordオブジェクトの解放
    If Not wdDoc Is Nothing Then
        wdDoc.Close
        Set wdDoc = Nothing
    End If
    
    If Not wdApp Is Nothing Then
        wdApp.Quit
        Set wdApp = Nothing
    End If
    
End Sub
```

---

## 8. テストデータ

### 8.1 正常系テストデータ

```
順位 | 企業名          | 総合得点
-----|-----------------|--------
1    | 楽天モバイル    | 69.52
2    | au              | 66.85
3    | docomo          | 66.55
4    | SoftBank        | 66.18
```

### 8.2 異常系テストケース

1. **データ欠損**
   - 企業名が空
   - 得点が0
   - 順位が欠番

2. **ファイルエラー**
   - 元データファイルが存在しない
   - テンプレートファイルが存在しない
   - 出力フォルダへの書き込み権限がない

3. **書式エラー**
   - 得点が数値でない
   - 順位が整数でない

---

## 9. 設定ファイル(config.ini)

将来的な拡張として、設定ファイルでパスを管理する案:

```ini
[Paths]
元データフォルダ=C:\Data\Rankings\
リリース表フォルダ=C:\Data\Output\
テンプレートフォルダ=C:\Templates\
出力フォルダ=C:\Output\

[Settings]
画像形式=PNG
画像DPI=300
Word形式=docx
デバッグモード=False

[Tables]
総合ランキング範囲=B7:D20
評価項目範囲=B8:X30
```

---

## 10. Claude Code実装チェックリスト

### 必須実装項目

- [ ] メインマクロ: `プレスリリース自動生成()`
- [ ] データ転記: `データ転記()`
  - [ ] 総合ランキング転記
  - [ ] 評価項目別転記
- [ ] 画像生成: `表を画像化()`
  - [ ] 総合ランキング画像化
  - [ ] 評価項目別画像化
- [ ] Word操作: `Word生成()`
  - [ ] 日付更新
  - [ ] タイトル生成
  - [ ] 本文生成
  - [ ] 画像差し替え
- [ ] エラーハンドリング
  - [ ] ファイル存在チェック
  - [ ] シート存在チェック
  - [ ] データ整合性チェック
- [ ] テストコード
  - [ ] 単体テスト
  - [ ] 統合テスト

### オプション実装項目

- [ ] 設定ファイル読み込み
- [ ] ログ出力機能
- [ ] 進捗表示UI
- [ ] バッチ処理機能

---

**この仕様書に基づいて、VBAコードの完全版を実装してください。**
