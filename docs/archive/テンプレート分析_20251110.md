# テンプレートファイル分析 - VBA実装方針書

**作成日**: 2025年11月10日
**目的**: 実ファイルベースのVBA実装方針策定
**アプローチ**: テンプレート駆動開発 (マクロ記録 → AI改善)

---

## 📁 テンプレートファイル一覧

### 1. Wordテンプレート (出力ファイル)

**ファイル名**: `【テンプレ】20XX年X月発表 【●●ランキング】ランキング ニュースリリース(オリコン顧客満足度調査).docx`

**サイズ**: 717,378 bytes (約700KB)
**用途**: プレスリリース完成版のテンプレート
**重要度**: 🔴 最重要

**想定される内容**:
- ヘッダー (ORICONロゴ、日付)
- タイトル部分 (調査名、年度)
- 本文テンプレート
- 画像挿入位置 (総合ランキング、評価項目別)
- フッター (問い合わせ先)

**VBA操作対象**:
- [ ] 日付の置換 (20XX年 → 2025年)
- [ ] タイトルの置換 (●●ランキング → 実際の調査名)
- [ ] 画像の差し替え (2箇所)
- [ ] 保存 (別名で)

---

### 2. リリース用表テンプレート (中間ファイル)

**ファイル名**: `【テンプレ】リリース内表.xlsx`

**サイズ**: 53,364 bytes (約52KB)
**用途**: 元データから転記後、画像化する表のテンプレート
**重要度**: 🟡 中

**想定される内容**:
- 整形済みの表フォーマット
- 総合ランキング表 (空欄)
- 評価項目別ランキング表 (空欄)
- 書式設定済み

**VBA操作対象**:
- [ ] 元データからデータ転記
- [ ] 表範囲をPNG画像化
- [ ] 画像を出力フォルダに保存

---

### 3. 元データサンプル

**ファイル名**: `【資料】携帯キャリア_ランキング結果2024.xlsx`

**サイズ**: 18,225 bytes (約18KB)
**用途**: 実際のランキングデータ (生データ)
**重要度**: 🟢 参照用

**想定される内容**:
- 総合順位、企業名、得点
- 評価項目別順位
- 回答者数などのメタデータ

**VBA操作対象**:
- [ ] データ読み込み (ReadOnly)
- [ ] リリース用表へ転記

---

## 🎯 テンプレートベースVBA実装方針

### アプローチの変更理由

**旧アプローチ** (AI生成コード):
- ❌ 架空のシート名・セル範囲
- ❌ 実ファイルとの整合性確認に時間
- ❌ 結局、全部手動調整が必要

**新アプローチ** (テンプレートベース):
- ✅ 実ファイルでマクロ記録 → 確実に動く
- ✅ AIは記録されたコードを改善するだけ
- ✅ 開発時間が1/3に短縮

---

## 📋 実装手順 (テンプレート駆動)

### Phase 1: マクロ記録 (30-45分) 👤 人間作業

#### Step 1.1: データ転記のマクロ記録

```vba
【操作手順】
1. Excelで「マクロの記録」開始
2. 元データファイル(【資料】携帯キャリア...)を開く
3. リリース用表ファイル(【テンプレ】リリース内表.xlsx)を開く
4. 手動でデータをコピペ:
   - 1位の企業名・得点を転記
   - 2位の企業名・得点を転記
   - 3位の企業名・得点を転記
   - (評価項目別も1つだけ試す)
5. マクロの記録を停止
6. 生成されたコードを保存: "recorded_data_transfer.txt"
```

**期待されるコード例**:
```vba
Workbooks.Open Filename:="C:\...\【資料】携帯キャリア_ランキング結果2024.xlsx"
Workbooks.Open Filename:="C:\...\【テンプレ】リリース内表.xlsx"

' 元データからコピー
Windows("【資料】携帯キャリア_ランキング結果2024.xlsx").Activate
Sheets("総合対象企業").Select
Range("C5").Select  ' 1位の企業名
Selection.Copy

' リリース表へ貼り付け
Windows("【テンプレ】リリース内表.xlsx").Activate
Sheets("総合3つ").Select
Range("C9").Select  ' 1位の貼り付け先
ActiveSheet.Paste
```

---

#### Step 1.2: 画像生成のマクロ記録

```vba
【操作手順】
1. Excelで「マクロの記録」開始
2. リリース用表ファイル(【テンプレ】リリース内表.xlsx)を開く
3. 総合ランキング表の範囲を選択 (例: B7:D20)
4. 「コピー」→「形式を選択して貼り付け」→「図(拡張メタファイル)」
5. 貼り付けた図を右クリック→「図として保存」→ PNG形式
6. マクロの記録を停止
7. 生成されたコードを保存: "recorded_image_export.txt"
```

**期待されるコード例**:
```vba
Sheets("総合3つ").Select
Range("B7:D20").Select
Selection.Copy
Range("F7").Select
ActiveSheet.Pictures.Paste.Select
Selection.ShapeRange(1).Fill.Visible = msoTrue

' または Chart経由
Dim cht As ChartObject
Set cht = ActiveSheet.ChartObjects.Add(...)
cht.Chart.Export Filename:="C:\...\総合ランキング.png", FilterName:="PNG"
```

---

#### Step 1.3: Word操作のマクロ記録

```vba
【操作手順】
1. Wordで「マクロの記録」開始
2. テンプレートファイル(【テンプレ】20XX年X月発表...)を開く
3. 「検索と置換」で "20XX年" → "2025年" に置換
4. 画像を選択して削除
5. 「挿入」→「図」→「ファイルから」→ 総合ランキング.pngを挿入
6. 別名で保存
7. マクロの記録を停止
8. 生成されたコードを保存: "recorded_word_operation.txt"
```

**期待されるコード例**:
```vba
Documents.Open FileName:="C:\...\【テンプレ】20XX年X月発表.docx"

' 置換
Selection.Find.ClearFormatting
Selection.Find.Replacement.ClearFormatting
With Selection.Find
    .Text = "20XX年"
    .Replacement.Text = "2025年"
    .Execute Replace:=wdReplaceAll
End With

' 画像挿入
Selection.InlineShapes.AddPicture _
    FileName:="C:\...\総合ランキング.png", _
    LinkToFile:=False, SaveWithDocument:=True

' 保存
ActiveDocument.SaveAs2 FileName:="C:\...\プレスリリース_20251110.docx"
```

---

### Phase 2: AIコード改善 (1時間) 🤖 AI作業

#### Step 2.1: 記録されたコードをAIに渡す

**プロンプト例**:
```
以下のマクロ記録コードをリファクタリングしてください。

【要件】
- 変数名を分かりやすく
- ハードコードされたパスを定数化
- エラーハンドリング追加
- ログ機能追加 (Module1_Main.LogMessage使用)
- For Loopで繰り返し処理を汎用化

【記録されたコード】
[recorded_data_transfer.txtの内容を貼り付け]
```

**期待される改善コード**:
```vba
Public Function TransferRankingData() As Boolean
    On Error GoTo ErrorHandler

    Const SOURCE_FILE As String = "【資料】携帯キャリア_ランキング結果2024.xlsx"
    Const TARGET_FILE As String = "【テンプレ】リリース内表.xlsx"

    Dim sourceWb As Workbook
    Dim targetWb As Workbook
    Dim sourceWs As Worksheet
    Dim targetWs As Worksheet

    Module1_Main.LogMessage "データ転記を開始します..."

    ' ファイルを開く
    Set sourceWb = Workbooks.Open(Module1_Main.FILES_DIR & SOURCE_FILE, ReadOnly:=True)
    Set targetWb = Workbooks.Open(Module1_Main.FILES_DIR & TARGET_FILE)

    Set sourceWs = sourceWb.Sheets("総合対象企業")
    Set targetWs = targetWb.Sheets("総合3つ")

    ' 上位3位を転記
    Dim i As Long
    For i = 1 To 3
        targetWs.Cells(8 + i, 3).Value = sourceWs.Cells(4 + i, 3).Value  ' 企業名
        targetWs.Cells(8 + i, 4).Value = Round(sourceWs.Cells(4 + i, 7).Value, 1)  ' 得点
    Next i

    targetWb.Save
    sourceWb.Close SaveChanges:=False
    targetWb.Close SaveChanges:=True

    Module1_Main.LogMessage "データ転記が完了しました"
    TransferRankingData = True
    Exit Function

ErrorHandler:
    Module1_Main.LogMessage "エラー: " & Err.Description
    On Error Resume Next
    If Not sourceWb Is Nothing Then sourceWb.Close SaveChanges:=False
    If Not targetWb Is Nothing Then targetWb.Close SaveChanges:=False
    TransferRankingData = False
End Function
```

---

### Phase 3: 統合とテスト (30分) 👤 人間 + 🤖 AI

#### Step 3.1: 改善されたコードをモジュールに統合

1. Module2_Data.basに改善されたデータ転記コードを追加
2. Module3_Image.basに改善された画像生成コードを追加
3. Module4_Word.basに改善されたWord操作コードを追加

#### Step 3.2: 動作確認

```vba
' テスト実行
Sub Test_FullProcess()
    Module1_Main.ExecuteReleaseCreation
End Sub
```

---

## 🔧 次回セッション作業計画

### 優先度: 🔴 高

#### タスク1: テンプレートファイルの構造確認 (15分)

**担当**: 人間

**確認事項**:
1. **Wordテンプレート**を開いて:
   - [ ] 置換対象の文字列を確認 ("20XX年", "●●ランキング"など)
   - [ ] 画像の位置を確認 (何枚目のInlineShape?)
   - [ ] フォーマット(フォント、色)を確認

2. **リリース用表**を開いて:
   - [ ] シート名を確認
   - [ ] 表の範囲を確認 (B7:D20など)
   - [ ] データを入れるセルを確認

3. **元データ**を開いて:
   - [ ] シート名を確認
   - [ ] データの場所を確認 (何行目から?)
   - [ ] 列の意味を確認 (C列=企業名、G列=得点など)

**成果物**: `テンプレート構造確認シート.xlsx` (メモ用)

---

#### タスク2: マクロ記録実施 (30分)

**担当**: 人間

**手順**:
1. データ転記を手動で1回実行しながらマクロ記録
2. 画像生成を手動で1回実行しながらマクロ記録
3. Word操作を手動で1回実行しながらマクロ記録

**成果物**:
- `recorded_data_transfer.txt`
- `recorded_image_export.txt`
- `recorded_word_operation.txt`

---

#### タスク3: 記録コードのAI改善 (30分)

**担当**: Claude Sonnet 4.5 (Multi-AI Orchestrator)

**入力**: 3つの記録されたVBAコード

**出力**:
- Module2_Data.bas (改善版)
- Module3_Image.bas (改善版)
- Module4_Word.bas (改善版)

---

### 優先度: 🟡 中

#### タスク4: Module5_Utilsの実装

既存のModule5_Utils.basに追加:
```vba
' テンプレートファイルパスを返す
Public Function GetTemplateWordPath() As String
Public Function GetTemplateExcelPath() As String
Public Function GetSourceDataPath() As String
```

---

## 📊 テンプレートベースアプローチの利点

### 時間短縮効果

| 作業 | AIアプローチ | テンプレートアプローチ | 削減率 |
|------|--------------|----------------------|--------|
| コード作成 | 2時間 | 30分 (マクロ記録) | -75% |
| デバッグ | 3時間 | 1時間 | -67% |
| 調整 | 2時間 | 30分 | -75% |
| **合計** | **7時間** | **2時間** | **-71%** |

### 品質向上効果

| 項目 | AIアプローチ | テンプレートアプローチ |
|------|--------------|----------------------|
| シート名の正確性 | ⚠️ 不確実 | ✅ 100%正確 |
| セル範囲の正確性 | ⚠️ 不確実 | ✅ 100%正確 |
| 動作保証 | ❌ テスト必要 | ✅ 記録時点で動作済み |
| パスの正確性 | ❌ 架空 | ✅ 実パス |

---

## 🎯 実装完了の定義

### Phase 1完了条件

- ✅ 3つのマクロ記録ファイル(.txt)が作成済み
- ✅ テンプレート構造確認シートが作成済み

### Phase 2完了条件

- ✅ Module2_Data.bas (改善版) が動作する
- ✅ Module3_Image.bas (改善版) が動作する
- ✅ Module4_Word.bas (改善版) が動作する

### Phase 3完了条件

- ✅ ExecuteReleaseCreation()を実行すると完成Wordが出力される
- ✅ エラーなく最後まで実行できる

---

## 📝 次回セッションへの申し送り

### 人間が事前準備すること

1. **テンプレートファイルを開いて構造確認** (15分)
   - Wordテンプレートの置換対象文字列をメモ
   - リリース用表のセル範囲をメモ
   - 元データの構造をメモ

2. **マクロ記録を実施** (30分)
   - データ転記
   - 画像生成
   - Word操作

3. **記録されたコードをテキストファイルに保存**

### AIが実施すること

1. **記録されたコードのリファクタリング**
   - 変数名の改善
   - エラーハンドリング追加
   - ログ機能追加
   - ループ化・汎用化

2. **改善コードのレビュー** (Gemini)

3. **統合と最終調整**

---

## 🚀 スケジュール更新

### Day 2 (11/11) - 修正版

| 時間 | 作業 | 担当 | 成果物 |
|------|------|------|--------|
| 30分 | テンプレート構造確認 | 人間 | 確認シート |
| 30分 | マクロ記録(3種) | 人間 | .txtファイル×3 |
| 30分 | AIコード改善 | Claude | Module2-4改善版 |
| 30分 | 統合とテスト | 人間+Claude | 動作確認 |

**合計**: 2時間 (従来計画より4時間短縮)

---

**結論**: テンプレートベースアプローチにより、確実性と速度が大幅に向上します。次回セッションから即座に実装を開始できます。

---

**作成者**: Claude Sonnet 4.5
**作成日時**: 2025年11月10日 18:35
**ステータス**: 方針確定・実装待ち
