# VBAモジュール管理

## 📁 フォルダ構造

```
vba_modules/
├── README.md                                    # このファイル
├── Module1_Main_Optimized_v4.1_SJIS.bas        # ✅ 最新: メイン制御
├── Module2_Data_Dynamic_SJIS.bas               # ✅ 最新: データ転記
└── archive/                                     # 過去バージョン（参照用）
    ├── utf8/                                   # UTF-8版ソースコード
    │   ├── Module1_Main_Optimized_v4.1.bas
    │   └── Module2_Data_Dynamic.bas
    ├── v1.0/                                   # 初期バージョン
    └── v3.0/                                   # 中間バージョン
```

---

## 🎯 現在使用中のモジュール

### Module1_Main_Optimized_v4.1_SJIS.bas
**バージョン**: 4.1
**エンコーディング**: Shift_JIS (CP932)
**サイズ**: 13,358文字

**機能**:
- 3ステップファイル選択ダイアログ
- パフォーマンス最適化（ScreenUpdating, Calculation, EnableEvents）
- 3フェーズ実行制御（データ転記 → 画像生成 → Word更新）
- 詳細ログ出力とエラーカウント

**主要関数**:
- `実行最適化版()` - メイン実行関数
- `SelectRequiredFiles()` - ファイル選択プロセス
- `LogMessage()` - ログ記録

---

### Module2_Data_Dynamic_SJIS.bas
**バージョン**: 4.0 (Dynamic)
**エンコーディング**: Shift_JIS (CP932)
**サイズ**: 17,885文字

**機能**:
- 完全動的データ転記（ハードコーディングなし）
- 総合ランキング3シート対応
- 評価項目最大12個対応（横4列×縦3行レイアウト）
- 動的検出アルゴリズム（DetectEvaluationItems）
- 柔軟なシート名検索（スペース・全角半角対応）

**主要関数**:
- `TransferRankingData()` - メイン転記関数
- `DetectEvaluationItems()` - 評価項目自動検出
- `Transfer_Overall_*()` - 総合ランキング転記
- `Transfer_EvaluationItems_Dynamic()` - 評価項目転記

**対応テンプレート**:
- 総合1つ
- 総合2つ
- 総合＋前回順位
- 評価・部門別（12項目まで）

---

## 🔄 開発履歴

| バージョン | 日付 | 主な変更 |
|-----------|------|---------|
| **v4.1** | 2025-11-11 | ファイル選択ダイアログ対応 |
| **v4.0** | 2025-11-11 | 完全動的化、12項目対応 |
| **v3.0** | 2025-11-11 | 最適化版、3フェーズ制御 |
| **v2.1** | 2025-11-11 | 画像生成改善 |
| **v1.0** | 2025-11-11 | 初期バージョン |

---

## 📝 使用方法

### 1. インポート手順

1. `マクロ.xlsm` を開く
2. `Alt + F11` でVBAエディタを開く
3. 既存のModule1, Module2を削除（あれば）
4. **ファイル** → **ファイルのインポート**
5. 以下を順番にインポート:
   - `Module1_Main_Optimized_v4.1_SJIS.bas`
   - `Module2_Data_Dynamic_SJIS.bas`

### 2. 実行方法

1. Excelに戻る
2. `Alt + F8` でマクロ一覧を開く
3. `実行最適化版` を選択して実行

### 3. ファイル選択

実行すると3ステップでファイル選択:
1. **ランキング結果ファイル**（ソースデータ）
2. **リリース内表ファイル**（ターゲット）
3. **Wordテンプレート**

---

## ⚙️ 設定・カスタマイズ

### 評価項目数の変更

`Module2_Data_Dynamic.bas` 内の `targetColumns` 配列を編集:

```vba
' 現在: 横4列×縦3行 = 12項目
targetColumns = Array( _
    Array(2, 10), Array(6, 10), Array(10, 10), Array(14, 10), _  ' 1行目
    Array(2, 16), Array(6, 16), Array(10, 16), Array(14, 16), _  ' 2行目
    Array(2, 22), Array(6, 22), Array(10, 22), Array(14, 22) _   ' 3行目
)
```

### 転記範囲の変更

各シートの範囲は `Transfer_Overall_*()` 関数内で定義されています。

---

## 🐛 トラブルシューティング

### コンパイルエラーが発生する

**原因**: Shift_JIS (CP932) エンコーディングの問題
**解決**: `archive/utf8/` から UTF-8版を使用して再変換

```bash
python scripts/convert_v4.1.py
```

### 評価項目が検出されない

**原因**: シート名のスペースや全角半角の違い
**解決**: `FindWorksheet()` 関数が自動対応（8パターン検索）

### 転記位置がずれる

**原因**: テンプレートレイアウトの変更
**解決**: `targetColumns` 配列を確認・修正

---

## 📦 バックアップ

重要なバージョンは `archive/` に保存されています:
- `archive/utf8/` - UTF-8ソースコード（編集用）
- `archive/v1.0/`, `archive/v3.0/` - 過去バージョン

---

## 📚 関連ドキュメント

- [変換スクリプト](../scripts/convert_v4.1.py) - UTF-8 → Shift_JIS変換
- [テンプレート分析](../テンプレート分析レポート_2025-11-11.md) - テンプレート構造解析

---

**最終更新**: 2025-11-11
**バージョン**: 4.1
**ステータス**: ✅ 本番環境で使用可能
